/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(['jquery.sap.global','./Calendar','./library','sap/ui/core/Control','sap/ui/core/theming/Parameters'],function(q,C,a,c,P){"use strict";var O=c.extend("sap.me.OverlapCalendar",{metadata:{library:"sap.me",properties:{startDate:{type:"string",group:"Data",defaultValue:null},weeksPerRow:{type:"int",group:"Appearance",defaultValue:2},firstDayOffset:{type:"int",group:"Appearance",defaultValue:0},showOverlapIndicator:{type:"boolean",group:"Appearance",defaultValue:false},visible:{type:"boolean",group:"Appearance",defaultValue:true},swipeToNavigate:{type:"boolean",group:"Behavior",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%'}},aggregations:{calendarEvents:{type:"sap.me.OverlapCalendarEvent",multiple:true,singularName:"calendarEvent"},calendar:{type:"sap.me.Calendar",multiple:false,visibility:"hidden"},typeLabels:{type:"sap.m.Label",multiple:true,singularName:"typeLabel",visibility:"hidden"},nameLabels:{type:"sap.m.Label",multiple:true,singularName:"nameLabel",visibility:"hidden"}},events:{endOfData:{parameters:{before:{type:"boolean"}}},changeDate:{parameters:{firstDate:{type:"object"},lastDate:{type:"object"}}}}}});O.prototype.init=function(){this.setAggregation("calendar",new C({singleRow:true,weeksPerRow:this.getWeeksPerRow(),monthsPerRow:1,monthsToDisplay:1,dayWidth:48,dayHeight:48,swipeToNavigate:this.getSwipeToNavigate()}));this.getCalendar().attachChangeCurrentDate(this.onCurrentDateChanged,this);this._typeWithBgImages=["04","07"];this._oDaysOverlap={};this._bRtl=sap.ui.getCore().getConfiguration().getRTL();};O.prototype.onswiperight=function(e){if(this.getSwipeToNavigate()){this.getCalendar().onswiperight(e);}};O.prototype.onswipeleft=function(e){if(this.getSwipeToNavigate()){this.getCalendar().onswipeleft(e);}};O.prototype.setSwipeToNavigate=function(s){this.getCalendar().setSwipeToNavigate(s);this.setProperty("swipeToNavigate",s,true);};O.prototype._getFirstDateDisplayed=function(){var f=this.getCalendar().getFirstDayOffset();var b=this._createDateInDays(this.getStartDate());var i=b.getDate();var d=b.getDay();b.setDate(1);var D=d+1-f;b.setDate(i-D+1);return b;};O.prototype._getLastDateDisplayed=function(){var w=this.getCalendar().getDays();var W=w.length;var i=this.getCalendar().getWeeksPerRow();var d=i*W;var b=this._getFirstDateDisplayed();var t=this._createDateInDays(b.getTime());t.setDate(t.getDate()+d-1);return t;};O.prototype.setWeeksPerRow=function(w){this.getCalendar().setWeeksPerRow(w);this.setProperty("weeksPerRow",w);};O.prototype.getCalendar=function(){return this.getAggregation("calendar");};O.prototype.setStartDate=function(d){this.getCalendar().setFirstDayOffset(0);this.getCalendar().setCurrentDate(d);this.setProperty("startDate",d);var o=this._getDaysOffset(this._createDateInDays(d),this._getFirstDateDisplayed());this.getCalendar().setFirstDayOffset(o);};O.prototype.onCurrentDateChanged=function(e){this.setProperty("startDate",e.getParameter("currentDate"),true);this.getCalendar().invalidate();this._renderCalendarEvents();this.fireChangeDate({firstDate:this._getFirstDateDisplayed(),endDate:this._getLastDateDisplayed()});};O.prototype.onBeforeRendering=function(){this._cleanUp();this._aRows=[];this._lastDate=null;this._firstDate=null;var b=this.getCalendarEvents();q.each(b,q.proxy(this._parseCalendarEvent,this));};O.prototype.onAfterRendering=function(){this._renderCalendarEvents();sap.ui.Device.resize.attachHandler(this._onResize,this);};O.prototype._onResize=function(){if(this._sDelayedResize){q.sap.clearIntervalCall(this._sDelayedResize);}this._sDelayedResize=q.sap.delayedCall(200,this,this._fireRecomputeElementsSizes);};O.prototype.exit=function(){this._cleanUp();};O.prototype._cleanUp=function(){sap.ui.Device.resize.detachHandler(this._onResize,this);};O.prototype._fireRecomputeElementsSizes=function(){var o=this.$();var e=o.find(".sapMeOverlapCalendarHalfDay");q.merge(e,o.find(".sapMeOverlapCalendarRowLabels"));this._sizeElementsToParent(e);};O.prototype._getDayId=function(d){var b=this._createDateInDays(this._getFirstDateDisplayed());return this._getDaysOffset(b,d);};O.prototype._cleanUpDivs=function(){var o=this.$();o.find(".sapMeOverlapCalendarDay").removeClass().addClass("sapMeOverlapCalendarDay");o.find(".sapMeOverlapCalendarHalfDay").remove();o.find(".sapMeOverlapCalendarDay.sapMeOverlapCalendarDayWithHalf").removeClass(".sapMeOverlapCalendarDayWithHalf");o.find(".sapMeOverlapCalendarOverlap").css("background-color","transparent").css("border","none");o.find(".sapMeOverlapCalendarTypeLbl").remove();};O.prototype._renderCalendarEvents=function(){var i;this._mHalfDays={};this._cleanUpDivs();this._oDaysOverlap={};var b=this.getCalendarEvents();q.each(b,q.proxy(this._renderCalendarEvent,this));q.each(this._mHalfDays,q.proxy(this._renderHalfDayCalendarEvent,this));if(this.getShowOverlapIndicator()){for(i in this._oDaysOverlap){if(this._oDaysOverlap[i]!=undefined&&this._oDaysOverlap[i]>1){var $=q.sap.byId(this._provideId("overlap",i));$.css("background-color",P.get("sapMeOverlapCalendarIndicator"));$.css("border-right","1px solid "+P.get("sapMeOverlapCalendarIndicator"));}}}if(this._firstDate&&this._lastDate){var d=this._getFirstDateDisplayed();d.setDate(d.getDate()+7);var e=this._getLastDateDisplayed();e.setDate(e.getDate()-7);if((this._dayIsBefore(this._lastDate,d))){this.fireEndOfData({before:false});}else if(this._dayIsAfter(this._firstDate,e)){this.fireEndOfData({before:true});}}};O.prototype._provideId=function(){var s=q.makeArray(arguments).join("-");return this.getId()+"-"+s;};O.prototype._addToDayOverlap=function(d){if(this._oDaysOverlap[d]==undefined){this._oDaysOverlap[d]=0;}this._oDaysOverlap[d]++;};O.prototype._getDaysOffset=function(f,s){return Math.floor(Math.abs(this._getRawDaysDifference(f,s)));};O.prototype._getDaysDifference=function(f,s){var d=this._getRawDaysDifference(f,s);return(d<0)?Math.ceil(d):Math.floor(d);};O.prototype._getRawDaysDifference=function(f,s){var b=86400000;var d=f.getTime();var e=s.getTime();var g=d-e;return(g/b);};O.prototype._dayIsAfter=function(d,b){return(this._getDaysDifference(d,b)>0);};O.prototype._dayIsBefore=function(d,b){return(this._getDaysDifference(d,b)<0);};O.prototype._createDateInDays=function(d){var b=new Date(d);b.setHours(0);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0);return b;};O.prototype._sizeElementsToParent=function(e){var b=(e!==null&&e.length)?e.length:0;var $,d;var i,w,h;for(i=0;i<b;i++){$=q(e[i]);if($){d=$.parent();w=d.width();h=d.height();$.width(w).height(h);}}};O.prototype._renderHalfDayCalendarEvent=function(k,h){var e=h[0];var $=q.sap.byId(k);var t=e.getType();var b=(q.inArray(t,this._typeWithBgImages)>-1);$.addClass("sapMeOverlapCalendarDayWithHalf");var d=q("<div/>");d.addClass("sapMeOverlapCalendarHalfDay").addClass("sapMeOverlapCalendarType"+t+"HalfDayStart");$.append(d);var f=null;if(h.length>1){var g=h[1];var i=g.getType();f=q("<div/>");f.addClass("sapMeOverlapCalendarHalfDay").addClass("sapMeOverlapCalendarType"+i+"HalfDayEnd");}else if(b){f=q("<div/>");f.addClass("sapMeOverlapCalendarHalfDay").addClass("sapMeOverlapCalendarTypeHalfDayEnd");}if(f!==null){$.append(f);}this._sizeElementsToParent([d,f]);};O.prototype._defineFirstAndLastDates=function(s,e){if(this._lastDate==undefined){this._lastDate=e;}if(this._dayIsAfter(e,this._lastDate)){this._lastDate=e;}if(this._firstDate==undefined){this._firstDate=s;}if(this._dayIsBefore(s,this._firstDate)){this._firstDate=s;}};O.prototype._renderCalendarEvent=function(i,o){var s=this._createDateInDays(o.getStartDay());var e=this._createDateInDays(o.getEndDay());this._defineFirstAndLastDates(s,e);var b=this._getFirstDateDisplayed();var l=this._getLastDateDisplayed();if((!this._dayIsBefore(e,b))&&(!this._dayIsAfter(s,l))){var r=o.getRow();var d=this._dayIsAfter(s,b)?s:b;e=this._dayIsAfter(e,l)?l:e;var n=this._getDaysOffset(d,e)+1;var f=this._getDaysOffset(b,d);var g="sapMeOverlapCalendarType"+o.getType();var $;var h;if(o.getHalfDay()===true){h=this._getDayId(d);var j=this._provideId(r,h);if(this._mHalfDays[j]==undefined){this._mHalfDays[j]=[];$=q.sap.byId(j);}this._mHalfDays[j].push(o);}else{while(!this._dayIsAfter(d,e)){h=this._getDayId(d);this._addToDayOverlap(h);$=q.sap.byId(this._provideId(r,h));$.addClass(g);d.setDate(d.getDate()+1);}}if($!=undefined){this._createEventLabel(o,d,n,f);}}};O.prototype._createEventLabel=function(o,d,n,b){var t=o.getTypeName();if(t&&t.length>0){var r=o.getRow();var l=this._provideId(r,this._getDayId(d));var e=this._provideId("row",r,"lbls");var $=q.sap.byId(e);$.width(q.sap.byId(this.getId()).width());var f=this._provideId("lbl",l);if(q.sap.byId(f).length===0){var g=q("<label dir='Inherit' id='"+f+"'>"+t+"</label>");$.append(g);g.addClass("sapMeOverlapCalendarTypeLbl sapMLabel");this._modifyLabel(g,n,b);}}};O.prototype._modifyLabel=function($,n,b){var d=(100/(this.getCalendar().getWeeksPerRow()*7));var w=(n*d);$.width(w+"%");var o=(b*d);var m=(b==0)?1:0.5;var l=o+"%";if(this._bRtl){$.css("right",l);$.css("padding-right",m+"rem");$.css("text-align","right");}else{$.css("left",l);$.css("padding-left",m+"rem");}};O.prototype._parseCalendarEvent=function(i,o){var r=o.getRow();if(r!=-1){if(o.getName()!=undefined){if(this._aRows[r]==undefined&&o.getName()!=""){this._aRows[r]=o.getName();}}else{q.sap.log.debug("Calendar event has no name");}}else{q.sap.log.debug("Invalid calendar event row");}};O.prototype._getLabelForRow=function(i){return this._getLabel(this._aRows[i],"nameLabels").addStyleClass("sapMeOverlapCalendarNameLbl");};O.prototype._getLabel=function(t,A){var l=new sap.m.Label({text:t});this.addAggregation(A,l,true);return l;};return O;},true);
