/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/Object','sap/ui/core/ComponentContainer','sap/ui/core/routing/HashChanger','sap/ui/core/routing/History','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/m/MessageBox','sap/m/MessagePage','sap/m/Link'],function(q,B,C,H,a,F,b,M,c,L){"use strict";var N=B.extend("sap.ui.generic.app.navigation.NavigationController",{metadata:{library:"sap.ui.generic.app"},constructor:function(o){if(!o||!o.getRouter()){throw"No component with router passed";}B.apply(this,arguments);this.oRouter=o.getRouter();this.oViews={};this.oComponent=o;this._oNavContainer=this.oComponent._oNavContainer;this._sNavigationTargetId=this._oNavContainer.getId();this.oRouter.attachRouteMatched(this._handleRouteMatched,this);this.oRouter.attachBypassed(this._handleBypassed,this);this.oRouter._oViews._getViewWithGlobalId=function(v){if(!this.oViews[v.viewName]){var r=this.oRouter.getRoute(v.viewName);if(r&&r._oConfig){this.oViews[v.viewName]=this._createComponentInstance(r._oConfig);}else{this.oViews[v.viewName]=sap.ui.view({viewName:v.viewName,type:v.type,height:"100%"});}}return this.oViews[v.viewName];}.bind(this);this._oHashChanger=H.getInstance();this._generateRoutingMetadata();this._initialise();}});N._sChanges="Changes";N.prototype._initialise=function(){var d;d=this.oComponent.getComponentData();if(d){this._oStartupParameters=d.startupParameters;}if(this._sEntitySet&&this._oStartupParameters&&!this._oHashChanger.getHash()){this._processStartupParameters();}else{this._initialiseRouting();}};N.prototype._processStartupParameters=function(){var m;m=this.oComponent.getModel();m.getMetaModel().loaded().then(function(){var e,E,f,d,s,h;f=function(k,p){var i,l,S=false,K,g;if(p&&k){l=k.length;for(i=0;i<l;i++){S=true;K=k[i];g=K.name||K.PropertyPath;if(!p[g]||p[g].length>1){S=false;break;}}}return S;};e=m.getMetaModel().getODataEntitySet(this._sEntitySet);if(e){E=m.getMetaModel().getODataEntityType(e.entityType);}if(E){d=f(E.key.propertyRef,this._oStartupParameters);}if(d){h=m.createKey(this._sEntitySet,this._oStartupParameters);if(h){this._oHashChanger.replaceHash(h);}}else{s=E["com.sap.vocabularies.Common.v1.SemanticKey"];d=f(s,this._oStartupParameters);if(d){this._readObject(s,this._oStartupParameters,m);return;}}this._initialiseRouting();}.bind(this));};N.prototype._initialiseRouting=function(){var h;this._oHistory=new a(this._oHashChanger);if(!this._oHashChanger.getHash()){h="";if(this._oStartupParameters&&this._oStartupParameters.route&&this._oStartupParameters.route.length===1){h=this._oStartupParameters.route[0];this._oHashChanger.replaceHash(h);}}this.oRouter.initialize();};N.prototype._generateRoutingMetadata=function(){var o=this.oComponent.getConfig(),t,T;if(!o.pages||!o.pages.length||o.pages.length===0){throw new Error("Route Configuration missing");}else if(o.pages.length>1){throw new Error("Currently only one Top route supported");}else{t=o.pages[0];this._sEntitySet=t.entitySet;T=this._createRoute(t,"root",0);this.oRouter.addRoute(T);this._createQueryRoute(T);this._createChildRoutes(t,0,null);}};N.prototype._createChildRoutes=function(r,l,p){var i,d;if(r.pages){d=r.pages.length;for(i=0;i<d;i++){this._createRoutes(r.pages[i],(l+1),p);}}};N.prototype._createRoutes=function(r,l,p){var n=this._createRoute(r,r.component.list?"aggregation":"detail",l,p);this.oRouter.addRoute(n);this._createQueryRoute(n);this._createChildRoutes(r,l,n);};N.prototype._createQueryRoute=function(r){var Q=q.extend({},r);Q.name=r.name+"query";Q.pattern=r.pattern+"{?query}";this.oRouter.addRoute(Q);};N.prototype._createRoute=function(r,o,l,p){var P,n;P=r.navigationProperty||r.entitySet;n=q.extend({},r);n.path="/"+r.entitySet;n.operation=o;n.viewLevel=l;n.template=r.component?(r.component.name||r.component):r.template;switch(o){case"root":n.name='root';n.pattern='';break;case"aggregation":n.name=P+"~aggregation";n.pattern=P;n.path=p.path||n.path;n.entitySet=p.entitySet||n.entitySet;break;default:n.name=P;n.pattern=P+"({keys"+l+"})";break;}if(p){n.name=p.name+"/"+n.name;n.pattern=p.pattern+"/"+n.pattern;n.parentEntitySet=p.entitySet;}n.view=n.name;n.controlId=this._sNavigationTargetId;n.controlAggregation="pages";return n;};N.prototype._createComponentInstance=function(r){var t,E,o,s;t=r.template;E=r.entitySet;s={appComponent:this.oComponent,isLeaf:!r.pages||!r.pages.length,subPages:r.pages,entitySet:E,navigationProperty:r.navigationProperty,componentData:{preprocessorsData:{}}};if(r.component.settings){q.extend(s,r.component.settings);}try{o=new C({name:t,propagateModel:true,width:'100%',height:'100%',handleValidation:true,settings:s});return o;}catch(e){throw new Error("Component "+t+" could not be loaded");}};N.prototype._handleRouteMatched=function(e){var v,r,k,K,p;v=e.getParameter("view");r=e.getParameter("config");sap.ui.getCore().getMessageManager().removeAllMessages();if(this._oTargetContextPath){p=this._oTargetContextPath;delete this._oTargetContextPath;}else if(r.operation!=="root"){p=this._getContextPath(r);K=e.getParameter("arguments");delete K["?query"];if(K){for(k in K){p=p.replace("{"+k+"}",K[k]);}}}this._activateView(v,p);};N.prototype._activateView=function(v,p,d){var o,O,e,V;if(v){if(v.getComponentInstance){e=v.getComponentInstance();if(!e){V={onBeforeRendering:function(){v.removeEventDelegate(V,this);if(v.getComponentInstance&&v.getComponentInstance()){this._activateView(v,p,true);}}};v.addEventDelegate(V,this);return;}}o=this._oNavContainer.getPreviousPage();if(!d&&(o||v!==this._oNavContainer.getCurrentPage())){o=this._oNavContainer.getCurrentPage();}if(o&&o.getComponentInstance){O=o.getComponentInstance();if(O&&O.onDeactivate){O.onDeactivate();}}if(e){if(e.onActivate){e.onActivate(p);}if(!e.getPreventBinding()){this._bindView(v,p);}}}};N.prototype._bindView=function(v,p){var e;if(v&&p){e=v.getModel().getProperty(p);if(e&&e.__metadata&&e.__metadata.created){v.unbindElement();v.setBindingContext(v.getModel().getContext(p));}else{v.bindElement({path:p,events:{dataReceived:this._handleDataReceived.bind(this)},batchGroupId:N._sChanges,changeSetId:N._sChanges});}}};N.prototype._navigate=function(h,r){if(!h){h="";}if(r){this.oRouter.oHashChanger.replaceHash(h);}else{this.oRouter.oHashChanger.setHash(h);}};N.prototype.navigateToRoot=function(r){this._navigate("",r);};N.prototype.navigateBack=function(r){this._navigate(this._oHistory?this._oHistory.getPreviousHash():"",r);};N.prototype.navigateToContext=function(t,n,r){var h=this.oRouter.oHashChanger.getHash(),p,T;if(t){p=this._getNavigationPath(t,n);if(n){T=function(h,m,d){var i;if(h&&m){if(isNaN(d)){d=0;}i=h.indexOf(m);if(i>-1){h=h.substring(0,i-d);}}return h;};if(n.indexOf("/")<0){n="/"+n;}h=T(h,n);h=T(h,"?");if(h){p=h+"/"+p;}}this._oTargetContextPath=t.getPath();this._navigate(p,r);}};N.prototype._getNavigationPath=function(t,n){var p,P,e;p=t.getPath().substring(1);P=p.split('(');if(P[0]){e=P[0];}if(n){p=p.replace(e,n);if(p.indexOf("/")===0){p=p.substring(1);}}return p;};N.prototype._getContextPath=function(r){var p,P,i;if(r){p=r.pattern;P=r.navigationProperty||r.entitySet;if(p&&P){i=p.indexOf("{?query}");if(i>0){p=p.substring(0,i);}i=-1;P+="({keys";i=p.indexOf(P);if(i>0){p=p.substring(i);}if(r.navigationProperty){p=p.replace(r.navigationProperty,r.entitySet);}p="/"+p;}}return p;};N.prototype.navigateToMessagePage=function(p){var e,t,r,T,E,o,h,i=null,m,R;if(p){e=p.entitySet;t=p.title;T=p.text;i=p.icon;r=p.replaceURL;}if(e){m=this.oComponent.getModel().getMetaModel();if(m){E=m.getODataEntitySet(e);o=m.getODataEntityType(E.entityType);h=o['com.sap.vocabularies.UI.v1.HeaderInfo'];}if(h&&h.TypeImageUrl&&h.TypeImageUrl.String){i=h.TypeImageUrl.String;}}if(this.oMessagePage){this.oMessagePage.destroy();}if(!this._sLinkText){R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app");this._sLinkText=R.getText("RETURN_TO_MAIN");}this.oMessagePage=new c({title:t,text:T,icon:i,customDescription:new L({text:this._sLinkText,press:this.navigateBack.bind(this,r)})});this._oNavContainer.addPage(this.oMessagePage);this._oNavContainer.to(this.oMessagePage);};N.prototype._handleBypassed=function(e){var r;if(!this._sNavigationTitle){r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app");this._sNavigationTitle=r.getText("UNKNOWN_NAVIGATION_TARGET");}this.navigateToMessagePage({title:this._sNavigationTitle,replaceURL:true});};N.prototype._handleDataReceived=function(e){var d=null,r;if(e){d=e.getParameter("data");if(!d){if(!this._sDataLoadFailedTitle||!this._sDataLoadFailedText){r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app");this._sDataLoadFailedTitle=r.getText("ERROR_LOAD_DATA_TITLE");this._sDataLoadFailedText=r.getText("ERROR_LOAD_DATA_TEXT");}this.navigateToMessagePage({title:this._sDataLoadFailedTitle,text:this._sDataLoadFailedText});}}};N.prototype.getViews=function(){return this.oViews;};N.prototype.getNavContainer=function(){return this._oNavContainer;};N.prototype._readObject=function(k,p,m){var i,l,P,v,f=[];if(k&&p&&m){l=k.length;for(i=0;i<l;i++){P=k[i].PropertyPath;v=p[P][0];f.push(new F(P,b.EQ,v));}m.read('/'+this._sEntitySet,{filters:f,success:function(r){var R,i,d,K;if(r&&r.results){d=r.results.length;for(i=0;i<d;i++){R=r.results[i];if(R&&R.IsActiveEntity){break;}R=null;}if(!R){R=r.results[0];}}if(R){K=m.getKey(R);}if(K){this._oHashChanger.replaceHash(K);}this._initialiseRouting();}.bind(this),error:function(e){this._initialiseRouting();}.bind(this)});}};N.prototype.destroy=function(){B.prototype.destroy.apply(this,arguments);if(this._oHistory&&this._oHistory.destroy){this._oHistory.destroy();}this._oHistory=null;this.oRouter=null;this.oViews=null;this.oComponent=null;this._sLinkText=null;this._sNavigationTitle=null;this._sDataLoadFailedText=null;this._sDataLoadFailedTitle=null;};return N;},true);
