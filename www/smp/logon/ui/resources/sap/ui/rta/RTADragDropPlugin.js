/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/dt/plugin/ControlDragDrop','sap/ui/dt/ElementUtil','sap/ui/dt/OverlayUtil','./Utils'],function(q,C,E,O,U){"use strict";var R=C.extend("sap.ui.rta.RTADragDropPlugin",{metadata:{library:"sap.ui.rta",properties:{},associations:{},events:{moveElement:{},hideElement:{},openContextMenu:{}}}});R.prototype.init=function(){C.prototype.init.apply(this,arguments);this._fnOnKeyDown=this._onKeyDown.bind(this);q(document).keydown(this._fnOnKeyDown);};R.prototype.exit=function(){C.prototype.exit.apply(this,arguments);q(document).off("keydown",this._fnOnKeyDown);delete this._fnOnKeyDown;};R.prototype.registerOverlay=function(o){o.attachBrowserEvent("click",this._onClick,this);o.attachEvent("selectableChange",this._onSelectableChange,this);o.attachBrowserEvent("contextmenu",this._onContextMenu,this);if(o.isDraggable()){this._attachDraggableBrowserEvents(o);}if(U.isOverlayMutable(o)){o.setSelectable(true);}else{o.setSelectable(false);}if(!o.getDomRef()){var _={onAfterRendering:function(e){var o=e.srcControl;if(o.isSelectable()){o.$().attr("tabindex",0);}o.removeEventDelegate(_);}};o.addEventDelegate(_);}C.prototype.registerOverlay.apply(this,arguments);};R.prototype.deregisterOverlay=function(o){C.prototype.deregisterOverlay.apply(this,arguments);o.detachBrowserEvent("click",this._onClick,this);o.detachEvent("selectableChange",this._onSelectableChange,this);o.detachBrowserEvent("contextmenu",this._onContextMenu,this);this._detachDraggableBrowserEvents(o);};R.prototype._attachDraggableBrowserEvents=function(o){o.attachBrowserEvent("mouseover",this._onMouseOver,this);o.attachBrowserEvent("mouseleave",this._onMouseLeave,this);};R.prototype._detachDraggableBrowserEvents=function(o){o.detachBrowserEvent("mouseover",this._onMouseOver,this);o.detachBrowserEvent("mouseleave",this._onMouseLeave,this);};R.prototype._onContextMenu=function(e){if(e.preventDefault){e.preventDefault();}var o=sap.ui.getCore().byId(e.originalEvent.currentTarget.id);if(o.isSelectable()){o.setSelected(true);this.fireOpenContextMenu({originalEvent:e,overlay:o});e.stopPropagation();}};R.prototype._onKeyDown=function(e){var o=U.getFocusedOverlay();if(e.keyCode===q.sap.KeyCodes.DELETE){this._hideElement();}else if((e.keyCode===q.sap.KeyCodes.ENTER)&&(e.shiftKey===false)&&(e.altKey===false)&&(e.ctrlKey===false)){if((o)&&(!o.isSelected())){o.setSelected(true);}}else if((e.keyCode===q.sap.KeyCodes.F10)&&(e.shiftKey===true)&&(e.altKey===false)&&(e.ctrlKey===false)){if(o){o.setSelected(true);var w=o.$().width()/2;var h=o.$().height()/2;var t=o.$().offset().top;var l=o.$().offset().left;var a=q.Event("click",{pageX:l+w,pageY:t+h});this.fireOpenContextMenu({originalEvent:a,overlay:o});}}else if((e.keyCode===q.sap.KeyCodes.ARROW_UP)&&(e.shiftKey===false)&&(e.altKey===false)&&(e.ctrlKey===false)){if(o){var p=o.getParentElementOverlay();if((p)&&(p.isSelectable())){p.focus();}}}else if((e.keyCode===q.sap.KeyCodes.ARROW_DOWN)&&(e.shiftKey===false)&&(e.altKey===false)&&(e.ctrlKey===false)){if(o){var f=U.getFirstFocusableChildOverlay(o);if(f){f.focus();}}}else if((e.keyCode===q.sap.KeyCodes.ARROW_LEFT)&&(e.shiftKey===false)&&(e.altKey===false)&&(e.ctrlKey===false)){if(o){var P=U.getPreviousFocusableSiblingOverlay(o);if(P){P.focus();}}}else if((e.keyCode===q.sap.KeyCodes.ARROW_RIGHT)&&(e.shiftKey===false)&&(e.altKey===false)&&(e.ctrlKey===false)){if(o){var n=U.getNextFocusableSiblingOverlay(o);if(n){n.focus();}}}};R.prototype._hideElement=function(){var d=this.getDesignTime();var s=d.getSelection();var S=s[0];if(S){var e=S.getElementInstance();this.fireHideElement({element:e});}};R.prototype.onDragStart=function(o){C.prototype.onDragStart.apply(this,arguments);this.getDesignTime().getSelection().forEach(function(o){o.setSelected(false);});o.$().addClass("sapUiRtaOverlayPlaceholder");var p=o.getParentElementOverlay().getElementInstance();this._oSourceParent=p;};R.prototype.onDragEnd=function(o){C.prototype.onDragEnd.apply(this,arguments);o.$().removeClass("sapUiRtaOverlayPlaceholder");o.setSelected(true);o.focus();this._onOverlayMoved(o);};R.prototype._onOverlayMoved=function(o){var m;if(E.isInstanceOf(o.getElementInstance(),"sap.ui.comp.smartform.Group")){m=this._createMoveEventInSmartForm("moveGroups",o);}else if(E.isInstanceOf(o.getElementInstance(),"sap.ui.comp.smartform.GroupElement")){m=this._createMoveEventInSmartForm("moveFields",o);}if(m){this.fireMoveElement(m);}};R.prototype._createMoveEventInSmartForm=function(t,o){var e=o.getElementInstance();var T=o.getParentElementOverlay().getElementInstance();var p=o.getParentAggregationOverlay().getAggregationName();var s=this._oSourceParent.getId();var a=T.getId();var i=this._getIndexInParentAggregation(T,p,e);var c={changeType:t,selector:{id:s},targetId:a!==s?a:null};c[t]=[{id:e.getId(),index:i}];return{element:this._oSourceParent,change:c};};R.prototype._getIndexInParentAggregation=function(p,a,e){var c=E.getAggregation(p,a);return c.indexOf(e);};R.prototype.onDraggableChange=function(o){C.prototype.onDraggableChange.apply(this,arguments);if(o.isDraggable()){this._attachDraggableBrowserEvents(o);}else{this._detachDraggableBrowserEvents(o);}};R.prototype.checkDraggable=function(o){var d=C.prototype.checkDraggable.apply(this,arguments);return d&&U.isOverlayMutable(o);};R.prototype.checkDroppable=function(a){var d=C.prototype.checkDroppable.call(this,a);if(d){var o=a.getParent();var s=O.getClosestOverlayForType("sap.ui.comp.smartform.SmartForm",o);var A=O.getClosestOverlayForType("sap.ui.comp.smartform.SmartForm",this.getDraggedOverlay());if(s!==A){d=false;}}return d;};R.prototype._onClick=function(e){var o=sap.ui.getCore().byId(e.currentTarget.id);if(o.isSelectable()){o.setSelected(!o.getSelected());e.preventDefault();e.stopPropagation();}};R.prototype._onSelectableChange=function(e){var o=e.getSource();var s=e.getParameter("selectable");if(s){o.$().attr("tabindex",0);}else{o.$().attr("tabindex",null);}};R.prototype._onMouseOver=function(e){var o=sap.ui.getCore().byId(e.currentTarget.id);if(o!==this._oPreviousHoverTarget){if(this._oPreviousHoverTarget){this._oPreviousHoverTarget.$().removeClass("sapUiRtaOverlayHover");}this._oPreviousHoverTarget=o;o.$().addClass("sapUiRtaOverlayHover");}e.preventDefault();e.stopPropagation();};R.prototype._onMouseLeave=function(e){if(this._oPreviousHoverTarget){this._oPreviousHoverTarget.$().removeClass("sapUiRtaOverlayHover");}delete this._oPreviousHoverTarget;e.preventDefault();e.stopPropagation();};return R;},true);
