/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","./Scene","./Viewport","./ContentResource","./NativeViewport","./Overlay","./SceneTree","sap/ui/layout/Splitter","sap/ui/layout/SplitterLayoutData","./FlexibleControl","./FlexibleControlLayoutData","./StepNavigation","./Toolbar","sap/ui/core/ResizeHandler"],function(q,l,C,S,V,a,N,O,b,c,d,F,e,f,g,R){"use strict";var h=q.sap.log;var i=C.extend("sap.ui.vk.Viewer",{metadata:{library:"sap.ui.vk",properties:{enableOverlay:{type:"boolean",defaultValue:false},enableSceneTree:{type:"boolean",defaultValue:false},showSceneTree:{type:"boolean",defaultValue:false},enableStepNavigation:{type:"boolean",defaultValue:false},showStepNavigation:{type:"boolean",defaultValue:false},enableToolbar:{type:"boolean",defaultValue:true},enableFullScreen:{type:"boolean",defaultValue:false},width:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},toolbarTitle:{type:"string",defaultValue:""}},publicMethods:["getGraphicsCore","getNativeViewport","getScene","getViewport","getViewStateManager"],aggregations:{contentResources:{type:"sap.ui.vk.ContentResource"},toolbar:{type:"sap.ui.vk.Toolbar",multiple:false,visibility:"hidden"},viewport:{type:"sap.ui.vk.Viewport",multiple:false,visibility:"hidden"},nativeViewport:{type:"sap.ui.vk.NativeViewport",multiple:false,visibility:"hidden"},stepNavigation:{type:"sap.ui.vk.StepNavigation",multiple:false,visibility:"hidden"},hotspotOverlay:{type:"sap.ui.vk.Overlay",multiple:false,visibility:"hidden"},sceneTree:{type:"sap.ui.vk.SceneTree",multiple:false,visibility:"visible"},_layout:{type:"sap.ui.vk.FlexibleControl",multiple:false,visibility:"true"},viewStateManager:{type:"sap.ui.vk.ViewStateManager",multiple:false,visibility:"hidden"}},events:{sceneLoadingSucceeded:{parameters:{scene:{type:"sap.ui.vk.Scene"}}},sceneLoadingFailed:{},sceneDestroying:{parameters:{scene:{type:"sap.ui.vk.Scene"}}},imageLoadingSucceeded:{},imageLoadingFailed:{},selectionChanged:{parameters:{selected:{type:"string[]"},unselected:{type:"string[]"}}},fullScreen:{parameters:{isFullScreen:{type:"boolean"}}}},specialSettings:{runtimeSettings:{type:"object"},webGLContextAttributes:{type:"object"}}},applySettings:function(s){if(s){this._runtimeSettings=s.runtimeSettings;this._webGLContextAttributes=s.webGLContextAttributes;delete s.runtimeSettings;delete s.webGLContextAttributes;}return C.prototype.applySettings.apply(this,arguments);},init:function(){h.debug("sap.ui.vk.Viewer.init() called.");if(C.prototype.init){C.prototype.init.apply(this);}this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.vk.i18n");this.setTooltip(this.oResourceBundle.getText("VIEWER_TITLE"));this._resizeListenerId=null;this._shouldLoadContentResources=true;this._busyIndicatorCounter=0;this._toolbar=null;this._viewport=null;this._nativeViewport=null;this._stepNavigation=null;this._hotspotOverlay=null;this._mainScene=null;this._sceneTree=null;this._updateSizeTimer=0;this._fullScreenToggle=false;this._oldWidth='100%';this._oldHeight='100%';this._content=new c(this.getId()+"-splitter",{orientation:"Horizontal"});this._stackedViewport=new F({width:"100%",height:"100%",layout:"Stacked"});this._layout=new F(this.getId()+"-flexibleControl",{width:"100%",height:"100%",layout:"Vertical"});this._stackedViewport.setLayoutData(new d({size:"100%",minSize:160,resizable:true}));this._content.addContentArea(this._stackedViewport);this.setAggregation("_layout",this._layout);},exit:function(){h.debug("sap.ui.vk.Viewer.exit() called.");if(this._sceneTree){this._sceneTree.setScene(null);}if(this._stepNavigation){this._stepNavigation.setScene(null);}this._toolbar=null;this._sceneTree=null;this._mainScene=null;this._nativeViewport=null;this._stepNavigation=null;this._viewport=null;this._setViewStateManager(null);if(this._graphicsCore){this._graphicsCore.destroy();this._graphicsCore=null;}if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}if(C.prototype.exit){C.prototype.exit.apply(this);}},_destroyMainScene:function(){if(this._mainScene){this.fireSceneDestroying({scene:this._mainScene});if(this._sceneTree){this._sceneTree.setScene(null,null);}if(this._stepNavigation){this._stepNavigation.setScene(null);}this._toolbar=null;this._viewport.setViewStateManager(null);this._setViewStateManager(null);if(this._viewport){this._viewport.setScene(null);}this._graphicsCore.destroyScene(this._mainScene);this._mainScene=null;}},getGraphicsCore:function(){return this._graphicsCore;},getScene:function(){return this._mainScene;},getViewStateManager:function(){return this.getAggregation("viewStateManager");},_setViewStateManager:function(v){if(!this._graphicsCore){return this;}if(v===this.getViewStateManager()){return this;}if(this.getViewStateManager()){this._graphicsCore.destroyViewStateManager(this.getViewStateManager());}this.setAggregation("viewStateManager",v,true);return this;},getViewport:function(){return this._viewport;},getNativeViewport:function(){return this._nativeViewport;},_getRuntimeSettings:function(){return this._runtimeSettings;},_getWebGLContextAttributes:function(){return this._webGLContextAttributes;},setEnableOverlay:function(p){if(p==this.getProperty("enableOverlay")){return;}this._activateOverlay(p);this.setProperty("enableOverlay",p,true);return this;},setEnableSceneTree:function(p){this.setProperty("enableSceneTree",p,true);if(!p){this.setProperty("showSceneTree",false);}this._updateLayout();return this;},setShowSceneTree:function(p){this.setProperty("showSceneTree",p,true);this._updateLayout();return this;},setEnableStepNavigation:function(p){this.setProperty("enableStepNavigation",p,true);if(!p){this.setProperty("showStepNavigation",false);}this._updateLayout();return this;},setShowStepNavigation:function(p){this.setProperty("showStepNavigation",p,true);this._updateLayout();return this;},setEnableToolbar:function(p){this.setProperty("enableToolbar",p,true);this._updateLayout();return this;},setEnableFullScreen:function(p){this.setProperty("enableFullScreen",p,true);this._fullScreenToggle=true;var v=document.getElementById(this.getId());var k=this.getProperty("enableFullScreen");var m=false;if(k){if(!(document.fullScreen||document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement)){this._oldWidth=this.getWidth();this._oldHeight=this.getHeight();var v=document.getElementById(this.getId());if(!this._fullScreenHandler){this._fullScreenHandler=function(n){if(!(document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement)){document.removeEventListener("fullscreenchange",this._fullScreenHandler.bind(this));document.removeEventListener("mozfullscreenchange",this._fullScreenHandler.bind(this));document.removeEventListener("webkitfullscreenchange",this._fullScreenHandler.bind(this));document.removeEventListener("msfullscreenchange",this._fullScreenHandler.bind(this));v.style.width=this._oldWidth;v.style.height=this._oldHeight;this._updateSize();this.fireFullScreen({isFullScreen:false});}};document.addEventListener("fullscreenchange",this._fullScreenHandler.bind(this));document.addEventListener("mozfullscreenchange",this._fullScreenHandler.bind(this));document.addEventListener("webkitfullscreenchange",this._fullScreenHandler.bind(this));document.addEventListener("msfullscreenchange",this._fullScreenHandler.bind(this));}m=true;if(v.requestFullScreen){v.requestFullScreen();}else if(v.webkitRequestFullScreen){v.webkitRequestFullScreen();}else if(v.mozRequestFullScreen){v.mozRequestFullScreen();}else if(v.msRequestFullscreen){v.msRequestFullscreen();}else{m=false;}if(m){v.style.width='100%';v.style.height='100%';}}}else{if(document.fullScreen||document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement){m=true;if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else{m=false;}if(m){v.style.width=this._oldWidth;v.style.height=this._oldHeight;}}}if(m){this._updateSize();this.fireFullScreen({isFullScreen:k});}return this;},destroyContentResources:function(s){this._shouldLoadContentResources=true;this._destroyMainScene();return this.destroyAggregation("contentResources",s);},invalidate:function(o){q.sap.log.debug("invalidate "+(o instanceof sap.ui.base.ManagedObject?o.getId():o));if(o instanceof a){this._shouldLoadContentResources=true;}return C.prototype.invalidate.apply(this,arguments);},onBeforeRendering:function(){if(this._fullScreenToggle){this._fullScreenToggle=false;}else{this._showToolbar();this._showSceneTree();this._showStepNavigation();if(this._shouldLoadContentResources){this._destroyMainScene();this._loadAllContentResources();}}if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}},onAfterRendering:function(){var k=this.getDomRef();this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:k.clientWidth,height:k.clientHeight}});},_handleResize:function(k){this._updateSize();},_updateSize:function(){if(this._updateSizeTimer){clearTimeout(this._updateSizeTimer);}this._updateSizeTimer=setTimeout(this._doUpdateSize.bind(this),100);},_doUpdateSize:function(){var k=this.getId()+"-flexibleControl";var m=document.getElementById(k);m.style.width='100%';m.style.height='100%';var n=m.clientHeight;var o=document.getElementById(k+"Content_0");var p=document.getElementById(k+"Content_1");var r=document.getElementById(k+"Content_2");n-=o.clientHeight;if(r!=null&&r.style.visibility!='hidden'){n-=r.clientHeight;}p.style.height=n+"px";},isTreeBinding:function(n){return n==="contentResources";},setBusy:function(k){if(k){if(this._busyIndicatorCounter===0){this.setBusyIndicatorDelay(0);C.prototype.setBusy.call(this,true);}this._busyIndicatorCounter+=1;}else{this._busyIndicatorCounter-=1;if(this._busyIndicatorCounter==0){C.prototype.setBusy.call(this,false);}}},_loadAllContentResources:function(){var h=q.sap.log;var r=this.getContentResources();if(r.length===0){return this;}var k=j(r);if(k.length===1){var m=k[0];if(m===sap.ui.vk.ContentResourceSourceCategory["3D"]){this.setBusy(true);this._showSceneTree();this._showViewport();this._showStepNavigation();this._destroyMainScene();this._graphicsCore.loadContentResourcesAsync(r,function(t){if(t){h.error("Some of content resources cannot be loaded.");this.fireSceneLoadingFailed();}else{var u=this._graphicsCore.buildSceneTree(r);if(u){this._mainScene=u;this._viewport.setScene(this._mainScene);this._setViewStateManager(this._graphicsCore.createViewStateManager(this._mainScene.getDefaultNodeHierarchy()));this._viewport.setViewStateManager(this.getViewStateManager());this.fireSceneLoadingSucceeded({scene:this._mainScene});this._sceneTree.setScene(this._mainScene,this.getViewStateManager());this.setEnableSceneTree(true);this.setShowSceneTree(true);this._stepNavigation.setScene(this._mainScene);this.setEnableStepNavigation(true);this.setShowStepNavigation(true);this.setShowStepNavigation(false);}else{this.fireSceneLoadingFailed();}}this.setBusy(false);this._shouldLoadContentResources=false;}.bind(this));}else if(m===sap.ui.vk.ContentResourceSourceCategory["2D"]){this.setEnableSceneTree(false);this.setEnableStepNavigation(false);if(r.length===1){var o=function(){this._shouldLoadContentResources=false;this.setBusy(false);if(this.getEnableOverlay()){this._activateOverlay(true);}this.fireImageLoadingSucceeded();}.bind(this);var n=function(){this._shouldLoadContentResources=false;this.setBusy(false);this.fireImageLoadingFailed();}.bind(this);this._showNativeViewport();this.setBusy(true);var p=r[0];if(p.getFile()){var s=new FileReader();s.onload=function(t){this._nativeViewport.loadUrl(s.result,o,n,null,p.getSourceType());}.bind(this);s.readAsDataURL(p.getFile());}else{this._nativeViewport.loadUrl(p.getSource(),o,n,null,p.getSourceType());}}else{h.error("Loading multiple 2D files is not supported yet");}}}else if(k.length>1){throw new Error("All content resources must have same category - either 3D or 2D.");}return this;},_showToolbar:function(){if(!this._toolbar){this._toolbar=new g({title:this.getToolbarTitle()});this._toolbar.setViewer(this);this.setAggregation("toolbar",this._toolbar);}this._toolbar.setVisible(this.getEnableToolbar());this._updateLayout();return this;},_updateLayout:function(){this._layout.setWidth(this.getWidth());this._layout.removeAllContent();this._layout.setHeight(this.getHeight());var k=this.getHeight();var m=[0,0,0];if(k=="auto"){k=400;}else if(k.substr(k.length-1)=='%'){k=400;}else{k=parseInt(k,10);}if(this._toolbar!=null&&this.getEnableToolbar()){m[0]=48;}if(this._stepNavigation!=null&&this.getShowStepNavigation()){m[2]=0;}m[1]=k-m[0]-m[2];if(this._toolbar!=null&&this.getEnableToolbar()){this._toolbar.setVisible(true);this._toolbar.setLayoutData(new e({size:m[0]+"px"}));this._layout.insertContent(this._toolbar,0);}else if(this._toolbar!=null){this._toolbar.setVisible(false);}if(this._sceneTree!=null&&this.getShowSceneTree()){this._sceneTree.setVisible(true);this._sceneTree.setLayoutData(new d({size:"320px",minSize:10,resizable:true}));this._content.insertContentArea(this._sceneTree,0);}else if(this._sceneTree!=null){this._content.removeContentArea(this._sceneTree);this._sceneTree.setVisible(false);}this._content.setLayoutData(new e({size:m[1]+"px"}));this._layout.addContent(this._content);if(this._stepNavigation!=null&&this.getShowStepNavigation()){if(this._graphicsCore!=null&&!this._stepNavigation.hasGraphicsCore()){this._stepNavigation.setGraphicsCore(this._graphicsCore);}this._stepNavigation.setVisible(true);this._layout.addContent(this._stepNavigation);}else if(this._stepNavigation!=null){this._stepNavigation.setVisible(false);}this._toolbar.refresh();this._updateSize();},_showSceneTree:function(){if(!this._sceneTree){this._sceneTree=new b();this.setAggregation("sceneTree",this._sceneTree);}this._sceneTree.setVisible(this.getShowSceneTree());this._updateLayout();return this;},_showStepNavigation:function(){if(!this._stepNavigation){this._stepNavigation=new f(this.getId()+"-stepNavigation",{visible:this.getShowStepNavigation()});this.setAggregation("stepNavigation",this._stepNavigation);}this._stepNavigation.setVisible(this.getShowStepNavigation());this._updateLayout();return this;},_showViewport:function(){if(!this._viewport){this._viewport=new V(this.getId()+"-viewport");this.setAggregation("viewport",this._viewport);}if(!this._graphicsCore){q.sap.require("sap.ui.vk.GraphicsCore");this._graphicsCore=new sap.ui.vk.GraphicsCore(this._getRuntimeSettings(),q.extend({antialias:true,alpha:true,premultipliedAlpha:false},this._getWebGLContextAttributes()));this._viewport.setGraphicsCore(this._graphicsCore);}if(this._nativeViewport){this._nativeViewport.setVisible(false);}this._stackedViewport.removeAllContent();this._stackedViewport.addContent(this._viewport);this._viewport.setVisible(true);return this;},_showNativeViewport:function(){if(!this._nativeViewport){this._nativeViewport=new N(this.getId()+"-nativeViewport");this.setAggregation("nativeViewport",this._nativeViewport);}if(this._viewport){this._viewport.setVisible(false);}this._stackedViewport.removeAllContent();this._stackedViewport.addContent(this._nativeViewport);this._nativeViewport.setVisible(true);return this;},_activateOverlay:function(E){if(E){var o=new sap.ui.vk.Overlay();this.setAggregation("hotspotOverlay",o);o.setTarget(this._nativeViewport);this._fillMockData();this._stackedViewport.addContent(o);}else{var o=this.getAggregation("hotspotOverlay");this._stackedViewport.removeContent(1);this.removeAllAggregation("hotspotOverlay");}},_fillMockData:function(){var o=this.getAggregation("hotspotOverlay");o.addArea(new sap.ui.vk.OverlayArea({position:'0.4;0.6;0;0.6;0.6;0;0.6;0.4;0;0.4;0.4;0',tooltip:'Area 1',changeable:false}));}});function j(r){var k=[];var m={};function n(o){var s=o.getSourceType();if(s){var p=sap.ui.vk.ContentResourceSourceTypeToCategoryMap[s]||"unknown";if(!m.hasOwnProperty(p)){m[p]=true;k.push(p);}}o.getContentResources().forEach(n);}r.forEach(n);return k;}return i;});
