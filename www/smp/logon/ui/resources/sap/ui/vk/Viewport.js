/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","./Loco","./ViewportHandler"],function(q,l,C,R,L,V){"use strict";var a=C.extend("sap.ui.vk.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["setGraphicsCore","getGraphicsCore","setScene","setViewStateManager","beginGesture","endGesture","pan","rotate","zoom","tap","queueCommand"]},init:function(){if(C.prototype.init){C.prototype.init(this);}this._graphicsCore=null;this._dvl=null;this._dvlRendererId=null;this._canvas=null;this._resizeListenerId=null;this._viewportHandler=new V(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);},exit:function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this.setViewStateManager(null);this.setScene(null);this.setGraphicsCore(null);if(C.prototype.exit){C.prototype.exit.apply(this);}},setGraphicsCore:function(g){if(g!=this._graphicsCore){if(g&&this._graphicsCore&&this._graphicsCore._getViewportCount()>0){throw new Error("Only one viewport instance is supported in the current implementation. This will change in future releases.");}if(this._graphicsCore){if(this._graphicsCore._unregisterViewport(this)){if(this._graphicsCore._getViewportCount()===0){this._dvl.Core.StopRenderLoop();}}}if(this._dvlRendererId){this._dvl.Core.DoneRenderer();this._dvlRendererId=null;}this._dvl=null;this._graphicsCore=g;if(this._graphicsCore){var s=this._graphicsCore._getViewportCount()===0;this._dvl=this._graphicsCore._getDvl();this._dvl.Core.InitRenderer();this._dvlRendererId=this._dvl.Core.GetRendererPtr();this._dvl.Renderer.SetBackgroundColor(0,0,0,0,0,0,0,0);this._setCanvas(this._graphicsCore._getCanvas());this._graphicsCore._registerViewport(this);if(s){this._dvl.Core.StartRenderLoop();}}}return this;},getGraphicsCore:function(){return this._graphicsCore;},_setCanvas:function(c){var s=this.getDomRef()&&this._canvas!==c;this._canvas=c;if(s){this.invalidate();}return this;},setScene:function(s){if(this._dvlRendererId){this._dvl.Renderer.AttachScene(s&&s._getDvlSceneId()||null);}return this;},onBeforeRendering:function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}},onAfterRendering:function(){if(this._canvas){var d=this.getDomRef();d.appendChild(this._canvas);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:d.clientWidth,height:d.clientHeight}});}},_handleResize:function(e){if(this._dvlRendererId&&this._canvas){var d=window.devicePixelRatio||1;var b=e.size.width*d;var c=e.size.height*d;this._dvl.Renderer.SetDimensions(b,c);this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*d);this._canvas.width=b;this._canvas.height=c;this._canvas.style.width=e.size.width+"px";this._canvas.style.height=e.size.height+"px";return true;}},setViewStateManager:function(v){this._viewStateManager=v;return this;},shouldRenderFrame:function(){return this._dvlRendererId&&this._dvl.Renderer.ShouldRenderFrame();},renderFrame:function(){if(this._dvlRendererId){this._dvl.Renderer.RenderFrame(this._dvlRendererId);}return this;},renderFrameEx:function(v,p){if(this._dvlRendererId){this._dvl.Renderer.RenderFrameEx.apply(this,[].concat(v,p),this._dvlRendererId);}return this;},setOption:function(o,e){if(this._dvlRendererId){this._dvl.Renderer.SetOption(o,e,this._dvlRendererId);}return this;},getOption:function(o){return this._dvlRendererId&&this._dvl.Renderer.GetOption(o,this._dvlRendererId);},setOptionF:function(o,v){if(this._dvlRendererId){this._dvl.Renderer.SetOptionF(o,v,this._dvlRendererId);}return this;},getOptionF:function(o){if(this._dvlRendererId){return this._dvl.Renderer.GetOptionF(o,this._dvlRendererId);}else{return 0;}},resetView:function(){if(this._dvlRendererId){this._dvl.Renderer.ResetView(this._dvlRendererId);}return this;},canIsolateNode:function(n){if(this._dvlRendererId){return this._dvl.Renderer.CanIsolateNode(n,this._dvlRendererId);}else{return false;}},setIsolatedNode:function(n){if(this._dvlRendererId){this._dvl.Renderer.SetIsolatedNode(n,this._dvlRendererId);}return this;},getIsolatedNode:function(){if(this._dvlRendererId){return this._dvl.Renderer.GetIsolatedNode(this._dvlRendererId);}else{return"i0000000000000000";}},zoomTo:function(w,n,c){if(this._dvlRendererId){this._dvl.Renderer.ZoomTo(w,n,c,this._dvlRendererId);}},beginGesture:function(x,y){if(this._dvlRendererId){var p=window.devicePixelRatio||1;this._dvl.Renderer.BeginGesture(x*p,y*p,this._dvlRendererId);}return this;},endGesture:function(){if(this._dvlRendererId){this._dvl.Renderer.EndGesture(this._dvlRendererId);}return this;},pan:function(d,b){if(this._dvlRendererId){var p=window.devicePixelRatio||1;this._dvl.Renderer.Pan(d*p,b*p,this._dvlRendererId);}return this;},rotate:function(d,b){if(this._dvlRendererId){var p=window.devicePixelRatio||1;this._dvl.Renderer.Rotate(d*p,b*p,this._dvlRendererId);}return this;},zoom:function(d){if(this._dvlRendererId){this._dvl.Renderer.Zoom(d,this._dvlRendererId);}return this;},tap:function(x,y,i){if(this._dvlRendererId){var p=window.devicePixelRatio||1;this._dvl.Renderer.Tap(x*p,y*p,i,this._dvlRendererId);}return this;},queueCommand:function(c){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(c,this._dvlRendererId);}return this;}});return a;});
