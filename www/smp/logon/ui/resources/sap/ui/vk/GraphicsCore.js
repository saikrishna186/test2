/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/base/EventProvider","sap/ve/dvl","./Scene","./NodeHierarchy","./ContentResource","./DownloadManager","./ViewStateManager","./DvlException"],function(q,l,E,D,S,N,C,a,V,b){"use strict";var c={Empty:"Empty",Local:"Local",Remote:"Remote"};var d=function(e,s){var o;if(typeof s==="string"){o=c.Remote;}else if(s===undefined){o=c.Empty;}else if(s instanceof File){o=c.Local;}else{throw new Error("Unsupported type of parameter 'source'.");}Object.defineProperties(this,{"dvlSceneId":{value:e,writable:false,enumerable:true},"source":{value:s,writable:false,enumerable:true},"origin":{value:o,writable:false,enumerable:true},"modified":{value:false,writable:true,enumerable:true}});};var G=E.extend("sap.ui.vk.GraphicsCore",{metadata:{publicMethods:["buildSceneTree","createViewStateManager","destroyScene","destroyViewStateManager","getApi","loadContentResourcesAsync","showDebugInfo"]},_DVLMajorVersion:5,_DVLMinorVersion:0,constructor:function(r,w){E.apply(this);var s=q.extend({},r,{filePackagePrefixURL:q.sap.getResourcePath("sap/ve")+"/"});this._dvlClientId=q.sap.uid();this._dvl=sap.ve.dvl.createRuntime(s);this._dvl.CreateCoreInstance(this._dvlClientId);this._dvl.Core.Init(this._DVLMajorVersion,this._DVLMinorVersion);this._canvas=this._createRenderingCanvasAndContext(w);this._sceneResources=[];this._vkScenesToSceneResourcesMap={};this._vkScenes=[];this._viewports=[];this._viewStateManagers=[];},destroy:function(){this._viewports.slice().forEach(function(v){v.setGraphicsCore(null);});this._viewports=null;this._vkScenes.forEach(this.destroyScene.bind(this));this._vkScenes=null;this._viewStateManagers.slice().forEach(this.destroyViewStateManager.bind(this));this._viewStateManagers=null;this._sceneResources.slice().forEach(this._destroySceneResource.bind(this));this._sceneResources=null;this._webGLContext=null;this._canvas=null;this._dvl.Core.Release();this._dvl=null;E.prototype.destroy.apply(this);},_createRenderingCanvasAndContext:function(w){var e=document.createElement("canvas");e.id=q.sap.uid();this._webGLContext=this._dvl.Core.CreateWebGLContext(e,w);return e;},_getCanvas:function(){return this._canvas;},_getWebGLContext:function(){return this._webGLContext;},_getDvl:function(){return this._dvl;},_getDvlClientId:function(){return this._dvlClientId;},_destroySceneResource:function(r){this._dvl.Scene.Release(r.dvlSceneId);switch(r.origin){case c.Local:this._dvl.Core.DeleteFileByUrl(r.source.name,"local");break;case c.Remote:this._dvl.Core.DeleteFileByUrl(r.source,"remote");break;default:break;}this._sceneResources.splice(this._sceneResources.indexOf(r),1);return this;},_findSceneResources:function(p){var e=Object.getOwnPropertyNames(p);return this._sceneResources.filter(function(i){return e.every(function(f){return p[f]===i[f];});});},loadContentResourcesAsync:function(e,o){function f(r){var i=[];function j(r){i=i.concat(r);r.forEach(function(k){j(k.getContentResources());});}j(r);return i;}var g=f(e);var s=q.sap.unique(g.map(function(i){return i.getFile()||i.getSource();}).filter(function(u){return u;}).filter(function(u){return this._findSceneResources({source:u,modified:false}).length===0;}.bind(this)));if(s.length>0){var h;new a(s).attachItemSucceeded(function(i){var j=i.getParameter("source");var k=j instanceof File;var n=k?j.name:j;var r=i.getParameter("response");try{var m=sap.ui.vk.dvl.getPointer(this._dvl.Core.LoadFileFromArrayBuffer(r,n,null,k?"local":"remote"));this._sceneResources.push(new d(m,j));}catch(p){if(p instanceof b){h=h||[];h.push({source:i.getParameter("source"),status:p.code,statusText:p.message});}else{throw p;}}},this).attachAllItemsCompleted(function(i){g.forEach(function(r){r.setLoaded();});if(o){o(h);}},this).attachItemFailed(function(i){h=h||[];h.push({source:i.getParameter("source"),status:i.getParameter("status"),statusText:i.getParameter("statusText")});},this).start();}else if(o){o();}return this;},buildSceneTree:function(e){var v,f,r,g;if(e.length===1&&(e[0].getSource()||e[0].getFile())){g=this._findSceneResources({source:e[0].getFile()||e[0].getSource(),modified:false})[0];if(g){r=e[0].getContentResources();}else{throw new Error("Content resource "+e[0].getSource()+" is not downloaded");}}else{g=new d(this._dvl.Core.CreateEmptyScene());this._sceneResources.push(g);r=e;}g.modified=true;f=g.dvlSceneId;v=new S(this,f);this._vkScenes.push(v);var h=this._vkScenesToSceneResourcesMap[v.getId()]=[g];var n=v.getDefaultNodeHierarchy();var i=function(s){return this._dvl.Scene.RetrieveSceneInfo(s,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN).ChildNodes;}.bind(this);var m=function(j,k){var o=this._dvl.Scene.CreateNode(f,j,k.getName());var p=n.createNodeProxy(o);k._setNodeProxy(p);var s=k.getLocalMatrix();if(s){p.setLocalMatrix(s);}var t=k.getFile()||k.getSource();if(t){var u=this._findSceneResources({source:t,modified:false})[0];i(u.dvlSceneId).forEach(function(w){this._dvl.Scene.CreateNodeCopy(f,w,o,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN);}.bind(this));if(h.indexOf(u)<0){h.push(u);}}k.getContentResources().forEach(m.bind(this,o));}.bind(this);r.forEach(m.bind(this,null));return v;},destroyScene:function(v){var e=v.getId();var f=this._vkScenes.indexOf(v);if(f<0){q.sap.log.warning("Scene with id '"+e+"' is not create by this GraphicsCore.");return this;}var g=this._vkScenesToSceneResourcesMap[e];this._vkScenes.splice(f,1);delete this._vkScenesToSceneResourcesMap[e];var h=Object.getOwnPropertyNames(this._vkScenesToSceneResourcesMap);g.filter(function(s){return!h.some(function(e){return this._vkScenesToSceneResourcesMap[e].indexOf(s);});}).forEach(this._destroySceneResource.bind(this));v.destroy();return this;},_registerViewport:function(v){if(this._viewports.indexOf(v)>=0){return false;}this._viewports.push(v);return true;},_unregisterViewport:function(v){var i=this._viewports.indexOf(v);if(i<0){return false;}this._viewports.splice(i,1);return true;},_getViewportCount:function(){return this._viewports.length;},createViewStateManager:function(n){var v=new V(n);this._viewStateManagers.push(v);return v;},destroyViewStateManager:function(v){var i=this._viewStateManagers.indexOf(v);if(i>=0){this._viewStateManagers.splice(i,1)[0].destroy();}return this;},showDebugInfo:function(e){this._viewports.forEach(function(v){v.setOption(sap.ve.dvl.DVLRENDEROPTION.DVLRENDEROPTION_SHOW_DEBUG_INFO,e);});return this;},getApi:function(e){switch(e){case sap.ui.vk.GraphicsCoreApi.LegacyDvl:return this._dvl;default:return null;}}});return G;});
