(function(){"use strict";jQuery.sap.declare("sap.ovp.cards.charts.Utils");sap.ovp.cards.charts.Utils=sap.ovp.cards.charts.Utils||{};sap.ovp.cards.charts.Utils.constants={DPQUALIFIER_KEY:"dataPointAnnotationPath",CHART_QUALIFIER_KEY:"chartAnnotationPath",SELVAR_QUALIFIER_KEY:"selectionAnnotationPath",PREVAR_QUALIFIER_KEY:"presentationAnnotationPath",CHART_DATA_SIZE:"4",DONUT_FRAGMENT:"sap.ovp.cards.charts.donut.DonutChart"};sap.ovp.cards.charts.Utils.getQualifier=function(c,a){if(typeof a==="undefined"||a===null){return"";}var s=c.getSetting('ovpCardProperties');if(!s){return"";}var S=s.oData;if(!S){return"";}var f=S&&S[a]?S[a]:"";return f===""?"":f.split("#")[1];};sap.ovp.cards.charts.Utils.wrapInBraces=function(w){return"{"+w+"}";};sap.ovp.cards.charts.Utils.formDimensionPath=function(d){var e=this.getModel('ovpCardProperties').getProperty("/entityType");var a=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(e);var t=a[d];if(t=="Edm.DateTime"){return"{path:'"+d+"', formatter: 'sap.ovp.cards.charts.Utils.returnDateFormat'}";}else{return"{"+d+"}";}};sap.ovp.cards.charts.Utils.returnDateFormat=function(d){jQuery.sap.require("sap.ui.core.format.DateFormat");var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd-MMM"});return D.format(new Date(d));};sap.ovp.cards.charts.Utils.formatItems=function(c,e,s,p,D,M){var r="";var a=[];var b=[];var f=[];var F=typeof s!=="undefined";var S=typeof p!=="undefined";if(S){S=typeof p.SortOrder!=="undefined";}r+="{path: '/"+e.name+"'";if(F){var g=[];var h=null;var j=null;if(c&&c.getSetting('ovpCardProperties')){h=c.getSetting('ovpCardProperties').getProperty("/entityType");j=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(h);}if(s&&s.SelectOptions){jQuery.each(s.SelectOptions,function(){var d=this.PropertyName.PropertyPath;jQuery.each(this.Ranges,function(){if(this.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"){var m=this.Low.String;if(j&&(j[d].substring(0,7)==="Edm.Int"||j[d].substring(0,11)==='Edm.Decimal')){m=Number(m);}var t={path:d,operator:this.Option.EnumMember.split("/")[1],value1:m};if(this.High){t.value2=this.High.String;}g.push(t);}});});}r+=", filters: "+JSON.stringify(g);}if(S){var o=p.SortOrder;var k="";var l;var n;var q;for(var i=0;i<o.length;i++){l=o[i];q=l.Property.PropertyPath;f.push(q);if(typeof l.Descending=="undefined"){n='true';}else{n=l.Descending.Boolean.toLowerCase()=='true'?'true':'false';}k=k+"{path: '"+q+"',descending: "+n+"},";}r+=", sorter: ["+k.substring(0,k.length-1)+"]";}jQuery.each(M,function(i,m){b.push(m.Measure.PropertyPath);});jQuery.each(D,function(i,d){a.push(d.Dimension.PropertyPath);});r+=", parameters: {select:'"+a.join(",")+","+b.join(",");if(f.length>0){r+=","+f.join(",");}r+="'}";r+=", length: "+sap.ovp.cards.charts.Utils.constants.CHART_DATA_SIZE+"}";return r;};sap.ovp.cards.charts.Utils.formatItems.requiresIContext=true;sap.ovp.cards.charts.Utils.listGroupBy=function(p){var P=typeof p!=="undefined";if(!P){return"";}var e=this.getModel('ovpCardProperties').getProperty("/entityType");var a=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r="";var g;if(p.GroupBy.constructor===Array){g=p.GroupBy;}else{g=p.GroupBy.Collection;}jQuery.each(g,function(){if(typeof a[this.PropertyPath]=="undefined"){return;}r+=a[this.PropertyPath];r+=", ";});if(r[r.length-1]===" "&&r[r.length-2]===","){r=r.substring(0,r.length-2);}return r==""?"":"By "+r;};sap.ovp.cards.charts.Utils.listFilters=function(c,s){var r="";var f=typeof s!=="undefined";if(!f){return r;}if(s&&s.SelectOptions){jQuery.each(s.SelectOptions,function(){jQuery.each(this.Ranges,function(){if(this.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"){r+=this.Low.String;if(this.High){r+="-"+this.High.String;}r+=", ";}});});}if(r[r.length-1]===" "&&r[r.length-2]===","){r=r.substring(0,r.length-2);}return r;};sap.ovp.cards.charts.Utils.listFilters.requiresIContext=true;sap.ovp.cards.charts.Utils.getAggregateNumber=function(c,e,m,s){var a=c.getSetting('ovpCardProperties').getProperty("/entityType");var u=sap.ovp.cards.charts.Utils.getUnitColumn(m,a);var f=typeof s!=="undefined";var b="";if(f){var d=[];var g=null;if(c&&c.getSetting('ovpCardProperties')){g=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(a);}if(s&&s.SelectOptions){jQuery.each(s.SelectOptions,function(){var p=this.PropertyName.PropertyPath;jQuery.each(this.Ranges,function(){if(this.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"){var h=this.Low.String;if(g&&(g[p].substring(0,7)==="Edm.Int"||g[p].substring(0,11)==='Edm.Decimal')){h=Number(h);}var i={path:p,operator:this.Option.EnumMember.split("/")[1],value1:h};if(this.High){i.value2=this.High.String;}d.push(i);}});});}b+=", filters: "+JSON.stringify(d);}if(!u){return"{path: '/"+e.name+"'"+", parameters:{select:'"+m+"'}"+b+"}";}return"{path: '/"+e.name+"'"+", parameters:{select:'"+m+","+u+"'}"+b+"}";};sap.ovp.cards.charts.Utils.getAggregateNumber.requiresIContext=true;sap.ovp.cards.charts.Utils.getFormattedNumber=function(v,U){var o=this.getModel("ovpCardProperties");if(!o){return;}var f=o.getProperty("/"+sap.ovp.cards.charts.Utils.constants.DPQUALIFIER_KEY);var e=o.getProperty("/entityType");var m=e[f].Value.Path;var i=sap.ovp.cards.charts.Utils.isACurrency(m,e);if(i){var c=sap.ui.core.format.NumberFormat.getCurrencyInstance({style:'short',showMeasure:false});return c.format(Number(v),U);}var d=Number(e[f].NumberFormat.NumberOfFractionalDigits.Int);var n=sap.ui.core.format.NumberFormat.getFloatInstance({style:'short',minFractionDigits:d,maxFractionDigits:d});return n.format(Number(v));};sap.ovp.cards.charts.Utils.returnSemanticColorForAggregateNumber=function(a){a=Number(a);var o=this.getModel("ovpCardProperties");if(!o){return;}var f=o.getProperty("/"+sap.ovp.cards.charts.Utils.constants.DPQUALIFIER_KEY);var d=o.getProperty("/entityType")[f];var i=d.CriticalityCalculation.ImprovementDirection.EnumMember.split("/")[1];var D,T,b,c;if(i=="Minimizing"){if(d.CriticalityCalculation.DeviationRangeHighValue&&d.CriticalityCalculation.ToleranceRangeHighValue&&d.CriticalityCalculation.DeviationRangeHighValue.String&&d.CriticalityCalculation.ToleranceRangeHighValue.String){D=Number(d.CriticalityCalculation.DeviationRangeHighValue.String);T=Number(d.CriticalityCalculation.ToleranceRangeHighValue.String);if(a<=T){return"Good";}else if(a>T&&a<=D){return"Critical";}else{return"Error";}}else{return"Neutral";}}else if(i=="Maximizing"){if(d.CriticalityCalculation.ToleranceRangeLowValue&&d.CriticalityCalculation.DeviationRangeLowValue&&d.CriticalityCalculation.ToleranceRangeLowValue.String&&d.CriticalityCalculation.DeviationRangeLowValue.String){b=Number(d.CriticalityCalculation.ToleranceRangeLowValue.String);c=Number(d.CriticalityCalculation.DeviationRangeLowValue.String);if(a>=b){return"Good";}else if(a<b&&a>=c){return"Critical";}else{return"Error";}}else{return"Neutral";}}else{if(d.CriticalityCalculation.DeviationRangeHighValue&&d.CriticalityCalculation.ToleranceRangeHighValue&&d.CriticalityCalculation.ToleranceRangeLowValue&&d.CriticalityCalculation.DeviationRangeLowValue&&d.CriticalityCalculation.DeviationRangeHighValue.String&&d.CriticalityCalculation.ToleranceRangeHighValue.String&&d.CriticalityCalculation.ToleranceRangeLowValue.String&&d.CriticalityCalculation.DeviationRangeLowValue.String){D=Number(d.CriticalityCalculation.DeviationRangeHighValue.String);T=Number(d.CriticalityCalculation.ToleranceRangeHighValue.String);b=Number(d.CriticalityCalculation.ToleranceRangeLowValue.String);c=Number(d.CriticalityCalculation.DeviationRangeLowValue.String);if((a<=T)&&(a>=b)){return"Good";}else if((a>T&&a<=D)||(a<b&&a>=c)){return"Critical";}else{return"Error";}}}};sap.ovp.cards.charts.Utils.returnTrendDirection=function(a){a=Number(a);var o=this.getModel("ovpCardProperties");if(!o){return;}var f=o.getProperty("/"+sap.ovp.cards.charts.Utils.constants.DPQUALIFIER_KEY);var d=o.getProperty("/entityType")[f];var r,u,b;if(!d.TrendCalculation){return;}if(d.TrendCalculation.ReferenceValue){r=Number(d.TrendCalculation.ReferenceValue.String);}if(d.TrendCalculation.UpDifference){u=Number(d.TrendCalculation.UpDifference.Int);}if(d.TrendCalculation.DownDifference){b=Number(d.TrendCalculation.DownDifference.Int);}if(r&&u&&(a-r>=u)){return"Up";}if(r&&b&&(a-r<=b)){return"Down";}};sap.ovp.cards.charts.Utils.returnPercentageChange=function(a){a=Number(a);var o=this.getModel("ovpCardProperties");if(!o){return;}var f=o.getProperty("/"+sap.ovp.cards.charts.Utils.constants.DPQUALIFIER_KEY);var d=o.getProperty("/entityType")[f];var r;if(!d.TrendCalculation){return;}if(d.TrendCalculation.ReferenceValue){r=Number(d.TrendCalculation.ReferenceValue.String);var p=((Number(a)-r)/r);var b=sap.ui.core.format.NumberFormat.getPercentInstance({style:'short',minFractionDigits:2,maxFractionDigits:2});if(p>0){return"+"+b.format(p);}return b.format(p);}};sap.ovp.cards.charts.Utils.formThePathForAggregateNumber=function(d){var m=d.Value.Path;var e=this.getModel('ovpCardProperties').getProperty("/entityType");var u=sap.ovp.cards.charts.Utils.getUnitColumn(m,e);return"{parts: [{path:'"+m+"'}, {path: '"+u+"'}], formatter: 'sap.ovp.cards.charts.Utils.getFormattedNumber'}";};sap.ovp.cards.charts.Utils.formThePathForUOM=function(d){var m=d.Value.Path;var e=this.getModel('ovpCardProperties').getProperty("/entityType");var u=sap.ovp.cards.charts.Utils.getUnitColumn(m,e);if(!u){return"";}return"{"+u+"}";};sap.ovp.cards.charts.Utils.formThePathForAggregateNumberColor=function(d){return"{parts: [{path:'"+d.Value.Path+"'}], formatter: 'sap.ovp.cards.charts.Utils.returnSemanticColorForAggregateNumber'}";};sap.ovp.cards.charts.Utils.formThePathForTrendIcon=function(d){return"{parts: [{path:'"+d.Value.Path+"'}], formatter: 'sap.ovp.cards.charts.Utils.returnTrendDirection'}";};sap.ovp.cards.charts.Utils.formPathForPercentageChange=function(d){return"{parts: [{path:'"+d.Value.Path+"'}], formatter: 'sap.ovp.cards.charts.Utils.returnPercentageChange'}";};sap.ovp.cards.charts.Utils.isACurrency=function(m,e){var p=e.property;for(var i=0,l=p.length;i<l;i++){if(p[i].name==m){if(p[i].hasOwnProperty("Org.OData.Measures.V1.ISOCurrency")){return true;}break;}}return false;};sap.ovp.cards.charts.Utils.getUnitColumn=function(m,e){var p=e.property;for(var i=0,l=p.length;i<l;i++){if(p[i].name==m){if(p[i].hasOwnProperty("sap:unit")){return p[i]["sap:unit"];}break;}}return null;};sap.ovp.cards.charts.Utils.getAllColumnProperties=function(p,e){var f={};var a=e.property;for(var i=0,l=a.length;i<l;i++){if(a[i].hasOwnProperty(p)&&p=="com.sap.vocabularies.Common.v1.Label"){f[a[i].name]=a[i][p].String;}else if(a[i].hasOwnProperty(p)){f[a[i].name]=a[i][p];}else{f[a[i].name]=a[i].name;}}return f;};sap.ovp.cards.charts.Utils.getAllColumnLabels=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("com.sap.vocabularies.Common.v1.Label",e);};sap.ovp.cards.charts.Utils.getAllColumnTexts=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("sap:text",e);};sap.ovp.cards.charts.Utils.getEdmTypeOfAll=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("type",e);};sap.ovp.cards.charts.Utils.formatChartYaxis=function(){jQuery.sap.require("sap.ui.core.format.NumberFormat");var c={locale:function(){},format:function(v,p){if(p=="yValueAxisFormatter"){var n=sap.ui.core.format.NumberFormat.getFloatInstance({style:'short',minFractionDigits:2,maxFractionDigits:2});return n.format(Number(v));}}};jQuery.sap.require("sap.viz.ui5.api.env.Format");sap.viz.ui5.api.env.Format.numericFormatter(c);};sap.ovp.cards.charts.Utils.hideDateTimeAxis=function(v,f){var e=v.getModel('ovpCardProperties').getProperty("/entityType");var a=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(e);var b=v.getFeeds();for(var i=0;i<b.length;i++){if(b[i].getUid()==f){var c=b[i].getValues();for(var j=0;j<c.length;j++){if(a[c[j]]!="Edm.DateTime"){return;}}v.setVizProperties({categoryAxis:{title:{visible:false}}});return;}}};sap.ovp.cards.charts.Utils.LineChart=sap.ovp.cards.charts.Utils.LineChart||{};sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList={};sap.ovp.cards.charts.Utils.LineChart.getValueAxisFeed=function(a){var r=[];jQuery.each(a,function(i,m){r.push(m.Measure.PropertyPath);});return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed=function(c,a){var r=[];var q;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){r.push(d.Dimension.PropertyPath);}});if(r.length<1){r.push(a[0].Dimension.PropertyPath);}q=sap.ovp.cards.charts.Utils.getQualifier(c,sap.ovp.cards.charts.Utils.constants.CHART_QUALIFIER_KEY);sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q]=r;return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.getColorFeed=function(c,a){var r=[];var q;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){r.push(d.Dimension.PropertyPath);}});q=sap.ovp.cards.charts.Utils.getQualifier(c,sap.ovp.cards.charts.Utils.constants.CHART_QUALIFIER_KEY);r=jQuery.grep(r,function(v){if(!sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q]){return true;}return v!=sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q][0];});return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.testColorFeed=function(c,d){return sap.ovp.cards.charts.Utils.LineChart.getColorFeed(c,d)!=="";};sap.ovp.cards.charts.Utils.LineChart.testColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart=sap.ovp.cards.charts.Utils.BubbleChart||{};sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList=function(a){var r=[null,null,null];jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis1"){if(r[0]===null){r[0]=m.Measure.PropertyPath;}else if(r[1]===null){r[1]=m.Measure.PropertyPath;}else if(r[2]==null){r[2]=m.Measure.PropertyPath;}}});jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis2"){if(r[0]===null){r[0]=m.Measure.PropertyPath;}else if(r[1]===null){r[1]=m.Measure.PropertyPath;}else if(r[2]==null){r[2]=m.Measure.PropertyPath;}}});jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis3"){if(r[0]===null){r[0]=m.Measure.PropertyPath;}else if(r[1]===null){r[1]=m.Measure.PropertyPath;}else if(r[2]==null){r[2]=m.Measure.PropertyPath;}}});return r;};sap.ovp.cards.charts.Utils.BubbleChart.getValueAxisFeed=function(m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(m)[0];};sap.ovp.cards.charts.Utils.BubbleChart.getValueAxis2Feed=function(m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(m)[1];};sap.ovp.cards.charts.Utils.BubbleChart.getBubbleWidthFeed=function(m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(m)[2];};sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed=function(a){var r=[];jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){r.push(d.Dimension.PropertyPath);}});return r.join(",");};sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed=function(a){var r=[];jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){r.push(d.Dimension.PropertyPath);}});return r.join(",");};sap.ovp.cards.charts.Utils.BubbleChart.testColorFeed=function(d){return sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed(d)!=="";};sap.ovp.cards.charts.Utils.BubbleChart.testShapeFeed=function(d){return sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed(d)!=="";};sap.ovp.cards.charts.Utils.AnalyticalCardHandler=function(v){this.sendParameters=0;this.parameterEntityType=undefined;this.entityTypeFunc=this.getEntityType;this._getEntityNavigationParametersFunc=this._getEntityNavigationParameters;this.clickHandler=function(){var p=this.getView().getModel('ovpCardProperties').getData();var a=p.hasOwnProperty("idenfiticationAnnotationPath")?p.idenfiticationAnnotationPath:"com.sap.vocabularies.UI.v1.Identification";var b=[];var e=this.getEntityType();var r=e[a];var c={};this.parameterEntityType={property:[]};for(var i=0;Array.isArray(r)&&i<r.length;i++){if(r[i].RecordType==='com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation'){b.push({semanticObject:r[i].SemanticObject.String,action:r[i].Action.String,label:r[i].Label.String});}if(r[i].RecordType==='com.sap.vocabularies.UI.v1.DataField'){c[r[i].Label.String]=r[i].Value.String;this.parameterEntityType.property.push({name:r[i].Label.String});}}var d={};d.getObject=function(){return c;};this.sendParameters=2;var f=b.length>0?b[0]:undefined;this.doIntentBasedNavigation(d,f);};this._getEntityNavigationParameters=function(e){if(this.sendParameters==2){this.sendParameters=1;}return this._getEntityNavigationParametersFunc.call(this,e);};this.getEntityType=function(){if(this.sendParameters!=1){return this.entityTypeFunc.apply(this);}this.sendParameters=0;return this.parameterEntityType;};this.getView().byId("ovpCardHeader").attachBrowserEvent("click",function(e){e.stopImmediatePropagation();this.clickHandler();}.bind(this));var t=this;v.attachBrowserEvent("click",t.clickHandler,t);};}());
