/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/base/ManagedObject','sap/ui/rta/ToolsMenu','sap/ui/rta/ContextMenu','sap/ui/comp/smartform/flexibility/FormP13nHandler','sap/ui/dt/Preloader','sap/ui/dt/ElementUtil','sap/ui/dt/DesignTime','sap/ui/dt/OverlayRegistry','sap/ui/rta/RTARenamePlugin','sap/ui/rta/RTADragDropPlugin','sap/ui/rta/FlexAdapter','sap/ui/rta/FieldRepository','./Utils','sap/ui/fl/Transports','sap/ui/fl/Utils','sap/m/MessageBox','sap/ui/comp/smartform/GroupElement','sap/ui/comp/smartform/Group'],function(M,T,C,F,D,E,a,O,R,b,c,d,U,e,f,g,G,h){"use strict";var j=M.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{"rootControl":{type:"sap.ui.core.Control"}},properties:{"customFieldUrl":"string","showCreateCustomField":"boolean"},events:{"start":{},"stop":{}}},_sAppTitle:null});j.prototype.start=function(){var t=this;this._aPopups=[];this._oTextResources=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(!this._oDesignTime){this._rootControl=sap.ui.getCore().byId(this.getRootControl());t._oFlexAdapter=new c();t._oFlexAdapter.init(t._rootControl);var i=sap.ui.dt.ElementUtil.findAllPublicElements(this._rootControl);this._oRTADragDropPlugin=new b({draggableTypes:["sap.ui.comp.smartform.Group","sap.ui.comp.smartform.GroupElement"]});this._oRTADragDropPlugin.attachEvent("moveElement",this._handleMoveElement,this);this._oRTADragDropPlugin.attachEvent("hideElement",this._handleHideElement,this);this._oRTADragDropPlugin.attachEvent("openContextMenu",this._handleOpenContextMenu,this);this._oRenamePlugin=new R({editableTypes:["sap.ui.comp.smartform.Group","sap.ui.comp.smartform.GroupElement"]});sap.ui.dt.Preloader.load(i).then(function(){t._oDesignTime=new a({rootElements:[t._rootControl],plugins:[t._oRTADragDropPlugin,t._oRenamePlugin]});t.fireStart();});}if(!this._oToolsMenu){this._sAppTitle=this._getApplicationTitle();this._oToolsMenu=new T();this._oToolsMenu.setTitle(this._sAppTitle);this._oToolsMenu.setRootControl(this._rootControl);this._oToolsMenu.adaptButtonsVisibility();this._oToolsMenu.attachEvent('close',this.stop,this);this._oToolsMenu.attachEvent('transport',this._onTransport,this);this._oToolsMenu.attachEvent('restore',this._onRestore,this);}this._fnOnKeyDown=this._onKeyDown.bind(this);jQuery(document).keydown(this._fnOnKeyDown);var o={"onAfterRendering":function(){this._oToolsMenu._oToolBarTop.focus();this._oToolsMenu._oToolBarTop.removeEventDelegate(o,this);}};this._oToolsMenu._oToolBarTop.addEventDelegate(o,this);this._openPopup=sap.ui.core.Popup.prototype.open;sap.ui.core.Popup.prototype.open=function(){if(t._aPopups.indexOf(this)===-1){t._aPopups.push(this);}jQuery(document).unbind("keydown",t._fnOnKeyDown);var k=Array.prototype.slice.call(arguments);t._openPopup.apply(this,k);};this._closePopup=sap.ui.core.Popup.prototype.close;sap.ui.core.Popup.prototype.close=function(){var I=t._aPopups.indexOf(this);if(I!==-1){t._aPopups.splice(I,1);if(t._aPopups.length===0){jQuery(document).keydown(t._fnOnKeyDown);}}var k=Array.prototype.slice.call(arguments);t._closePopup.apply(this,k);};this._oToolsMenu.show();};j.prototype.stop=function(){this.exit();this.fireStop();};j.prototype.exit=function(){if(this._oToolsMenu){this._oToolsMenu.destroy();this._oToolsMenu=null;}if(this._oFlexAdapter){this._oFlexAdapter.destroy();}if(this._oDesignTime){this._oDesignTime.destroy();this._oDesignTime=null;}if(this._fnOnKeyDown){jQuery(document).unbind("keydown",this._fnOnKeyDown);this._fnOnKeyDown=null;}sap.ui.core.Popup.prototype.open=this._openPopup;sap.ui.core.Popup.prototype.close=this._closePopup;};j.prototype._onKeyDown=function(o){if((o.keyCode===jQuery.sap.KeyCodes.TAB)&&(o.shiftKey===false)&&(o.altKey===false)&&(o.ctrlKey===false)){o.preventDefault();this._focusNextElement();}else if((o.keyCode===jQuery.sap.KeyCodes.TAB)&&(o.shiftKey===true)&&(o.altKey===false)&&(o.ctrlKey===false)){o.preventDefault();this._focusPrevElement();}};j.prototype._focusNextElement=function(){var s=this._checkCurrentFocusedElement();if(s==="NOT RTA"){this._oToolsMenu._oToolBarTop.focus();}else if(s==="OVERLAY"){this._handleNextOverlay();}else if(s.indexOf("TB")!==-1){this._handleNextTbElement();}};j.prototype._focusPrevElement=function(){var s=this._checkCurrentFocusedElement();if(s==="NOT RTA"){this._oToolsMenu._oToolBarTop.focus();}else if(s==="OVERLAY"){this._handlePrevOverlay();}else if(s==="TOP TB"){this._handlePrevTbElement();}else if(s==="BOTTOM TB"){this._handlePrevOverlay();}else if(s==="TOP TB ELEMENT"){this._handlePrevTbElement();}else if(s==="BOTTOM TB ELEMENT"){this._handlePrevTbElement();}};j.prototype._checkCurrentFocusedElement=function(){var s;var o=document.activeElement;this._aTbTopElements=this._oToolsMenu._oToolBarTop.getContent();var t=[];for(var i=this._aTbTopElements.length-1;i>=0;i--){if(this._aTbTopElements[i].getId().indexOf("spacer")>-1){this._aTbTopElements.splice(i,1);}}var k=this._aTbTopElements.length;for(i=0;i<k;i++){t[i]=this._aTbTopElements[i].getId();}this._aTbBottomElements=this._oToolsMenu._oToolBarBottom.getContent();var l=[];for(i=this._aTbBottomElements.length-1;i>=0;i--){if(this._aTbBottomElements[i].getId().indexOf("spacer")>-1){this._aTbBottomElements.splice(i,1);}}var B=this._aTbBottomElements.length;for(i=0;i<B;i++){l[i]=this._aTbBottomElements[i].getId();}var A=t.indexOf(o.id);var m=l.indexOf(o.id);if((o.getAttribute("class"))&&(o.getAttribute("class").search("sapUiDtOverlay")>-1)){this._sArea="OVERLAY";s="OVERLAY";return s;}else if((o.getAttribute("class"))&&(o.getAttribute("class").search("sapUiRTAToolBarTop")>-1)){this._sArea="TOP";this._iActive=-1;this._aElements=this._aTbTopElements;s="TOP TB";return s;}else if((o.getAttribute("class"))&&(o.getAttribute("class").search("sapUiRTAToolBarBottom")>-1)){this._sArea="BOTTOM";this._iActive=-1;this._aElements=this._aTbBottomElements;s="BOTTOM TB";return s;}else if(A>-1){this._sArea="TOP";this._iActive=A;this._aElements=this._aTbTopElements;s="TOP TB ELEMENT";return s;}else if(m>-1){this._sArea="BOTTOM";this._iActive=m;this._aElements=this._aTbBottomElements;s="BOTTOM TB ELEMENT";return s;}else{s="NOT RTA";return s;}};j.prototype._loopOverTbElements=function(r,s){for(var i=s,k=(r)?-1:this._aElements.length,l=(r)?-1:1;i!=k;i+=l){this._aElements[i].focus();if(this._aElements[i].getId()===document.activeElement.id){break;}if(i===k-l){if(!r){(this._sArea==="TOP")?this._handleNextOverlay():this._oToolsMenu._oToolBarTop.focus();}else{if(((this._sArea==="TOP")&&(this._iActive===-1))||(this._sArea==="OVERLAY")){this._oToolsMenu._oToolBarBottom.focus();}else if(((this._sArea==="TOP")&&(this._iActive>0))||(this._sArea==="BOTTOM")){this._oToolsMenu._oToolBarTop.focus();}}}}};j.prototype._handleNextTbElement=function(){if(this._iActive===this._aElements.length-1){(this._sArea==="TOP")?this._handleNextOverlay():this._oToolsMenu._oToolBarTop.focus();}else{this._loopOverTbElements(false,this._iActive+1);}};j.prototype._handlePrevTbElement=function(){if(this._sArea==="TOP"){switch(this._iActive){case-1:this._aElements=this._aTbBottomElements;if(this._aElements.length===0){this._oToolsMenu._oToolBarBottom.focus();}else{this._loopOverTbElements(true,this._aElements.length-1);}break;case 0:this._oToolsMenu._oToolBarTop.focus();break;default:this._loopOverTbElements(true,this._iActive-1);}}else if(this._sArea==="OVERLAY"){this._aElements=this._aTbTopElements;if(this._aElements.length===0){this._oToolsMenu._oToolBarTop.focus();}else{this._loopOverTbElements(true,this._aElements.length-1);}}else if(this._sArea==="BOTTOM"){this._loopOverTbElements(true,this._aElements.length-1);}};j.prototype._handleNextOverlay=function(){var o;if(this._sArea==="TOP"){o=U.getFirstFocusableOverlay();(o)?o.focus():this._oToolsMenu._oToolBarBottom.focus();}else if(this._sArea==="OVERLAY"){o=U.getNextFocusableOverlay();(o)?o.focus():this._oToolsMenu._oToolBarBottom.focus();}};j.prototype._handlePrevOverlay=function(){var o;if(this._sArea==="BOTTOM"){o=U.getLastFocusableOverlay();if(o){o.focus();}else{this._sArea="OVERLAY";this._handlePrevTbElement();}}else if(this._sArea==="OVERLAY"){o=U.getPreviousFocusableOverlay();(o)?o.focus():this._handlePrevTbElement();}};j.prototype._onTransport=function(){this._ensureFormP13Handler();this._handler._oSmartForm=this._rootControl;var t=this;function i(o){f.log.error("SmartForm changes could not be applied or saved: "+o);return t._handler._showApplySaveChangesErrorMessage(o).then(function(){throw new Error('createAndApply failed');});}function k(o){if(o.message==='createAndApply failed'){return;}f.log.error("transport error"+o);return t._handler._showTransportErrorMessage(o);}return this._handler._getFlexController().getComponentChanges().then(function(o){return t._handler._convertToChangeArray(o);}).then(function(A){if(A.length>0){return t._handler._createAndApplyChanges(A);}})['catch'](i).then(function(){return t._handler._getFlexController().getComponentChanges();}).then(function(A){return!!A.length;}).then(function(s){if(s){return t._handler._openTransportSelection(null,true);}else{return t._handler._showTransportInapplicableMessage();}}).then(function(o){if(o&&o.transport&&o.packageName!=="$TMP"){return t._transportAllLocalChanges(o);}})['catch'](k);};j.prototype._deleteChanges=function(i){var t=this;var o=t._handler._getFlexController();var k=i.length-1;return this._handler._setTransports(i,k).then(function(){return o.discardChanges(i);}).then(function(){return t._handler._showDiscardSuccessMessage();})["catch"](function(l){return t._handler._showDiscardErrorMessage(l);});};j.prototype._ensureFormP13Handler=function(){if(!this._handler){this._handler=new F();this._handler.init(this._rootControl);}};j.prototype._onRestore=function(){var t=this;var m=this._oTextResources.getText("FORM_PERS_RESET_MESSAGE");var s=this._oTextResources.getText("FORM_PERS_RESET_TITLE");this._ensureFormP13Handler();function i(A){if(A==="OK"){var o=t._handler._getFlexController();o.getComponentChanges().then(function(k){var l=t._handler._convertToChangeArray(k);return t._deleteChanges(l);})["catch"](function(k){return t._handler._showDiscardErrorMessage();});}}g.confirm(m,{title:s,onClose:i});};j.prototype._transportAllLocalChanges=function(t){var i=this;return i._handler._getFlexController().getComponentChanges().then(function(A){var k=i._handler._convertToChangeTransportData(A);var o=new e();var l={};l.transportId=t.transport;l.changeIds=k;return o.makeChangesTransportable(l).then(function(){A.forEach(function(m){if(m.getPackage()==='$TMP'){var n=m.getDefinition();n.packageName='';m.setResponse(n);}});}).then(function(){return i._handler._showTransportSuccessMessage();});});};j.prototype._handleMoveElement=function(o){var i=o.getParameters();this._oFlexAdapter.emitMoveEvent(i.element,i.change);};j.prototype._handleHideElement=function(o){var i=o.getParameters();var t=this;if(U.isElementHideable(i.element)){this._oFlexAdapter.emitHideEvent(i.element);}else{this._openHideElementDialog(i.element).then(function(r){if(r){t._oFlexAdapter.emitHideEvent(i.element);}});}};j.prototype._openHideElementDialog=function(o){var t=this;var m;var s;return new Promise(function(r,i){var k=function(A){if(A==="OK"){r(true);}else{r(false);}};if(o instanceof h){m=t._oTextResources.getText("CTX_HIDE_GROUP_MESSAGE");s=t._oTextResources.getText("CTX_HIDE_GROUP_TITLE");}else if(o instanceof G){m=t._oTextResources.getText("CTX_HIDE_FIELD_MESSAGE");s=t._oTextResources.getText("CTX_HIDE_FIELD_TITLE");}g.confirm(m,{title:s,icon:"WARNING",onClose:k});});};j.prototype._handleOpenContextMenu=function(o){var i=o.getParameter("originalEvent");var k=o.getParameter("overlay");this._oContextMenu=new C();this._oContextMenu.attachEvent("renameLabel",this._handleRenameLabel,this);this._oContextMenu.attachEvent("hideElement",this._handleHideElement,this);this._oContextMenu.attachEvent("addElement",this._handleAddElement,this);this._oContextMenu.attachEvent("addGroup",this._handleAddGroup,this);this._oContextMenu.attachEvent("adaptElement",this._handleAdaptElement,this);var l=k.getElementInstance();this._oContextMenu.setElement(l);this._oContextMenu.setOverlayDomRef(k);this._oContextMenu.openMenu({pageX:i.pageX,pageY:i.pageY});};j.prototype._handleRenameLabel=function(o){var i=O.getOverlay(o.getParameter("element").getId());this._oRenamePlugin.setEditMode(i);};j.prototype._handleAddElement=function(o){var i=o.getParameter("element");if(!this._oFieldRepository){this._oFieldRepository=new d({rootControl:this._rootControl});this._oFieldRepository.attachEvent("openCustomField",this._onOpenCustomField,this);}this._openFieldRepository(i);};j.prototype._openFieldRepository=function(o){var t=this;U.isCustomFieldAvailable(o).then(function(r){if(r){t._oFieldRepository.setShowCreateCustomField(true);t._oCurrentFieldExtInfo=r;}});this._oFieldRepository.open(o);};j.prototype._handleAddGroup=function(o){var I=0;var t=this;var k=o.getParameters();var l=k.element;var m=null;if(l.getMetadata().getName()==="sap.ui.comp.smartform.Group"){var n=l.getParent().getAggregation("formContainers");for(var i=0;i<n.length;i++){if(n[i].getId()===l.getId()){I=i+1;break;}}m=this._oFlexAdapter.emitAddEvent({selectorId:l.getParent().getParent().getId(),index:I},c.M_TYPES.addGroup);}else if(l.getMetadata().getName()==="sap.ui.comp.smartform.SmartForm"){I=0;m=this._oFlexAdapter.emitAddEvent({selectorId:l.getId(),index:I},c.M_TYPES.addGroup);}var p=O.getOverlay(m.newControlId);p.setSelected(true);var q={"onAfterRendering":function(){t._oRenamePlugin.setEditMode(p);p.removeEventDelegate(q);}};p.addEventDelegate(q);};j.prototype._handleAdaptElement=function(o){var i=o.getParameter("element");if(!this._handler){this._handler=new F();}this._handler.init(i);this._handler.show();};j.prototype._getApplicationTitle=function(){var t="";var o=sap.ui.core.Component.getOwnerComponentFor(this._rootControl);if(o){t=o.getMetadata().getManifestEntry("sap.app").title;}return t;};return j;},true);
