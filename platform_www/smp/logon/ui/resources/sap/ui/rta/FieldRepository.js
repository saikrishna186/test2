/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control','sap/ui/commons/Label','sap/ui/commons/LabelDesign','sap/ui/commons/Dialog','sap/ui/commons/TextView','sap/ui/commons/CheckBox','sap/ui/table/Table','sap/ui/table/SelectionMode','sap/ui/table/SelectionBehavior','sap/ui/table/NavigationMode','sap/ui/core/HorizontalAlign','sap/ui/layout/VerticalLayout','sap/ui/layout/HorizontalLayout','sap/ui/model/json/JSONModel','sap/m/SearchField','sap/m/Button','sap/m/Toolbar','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/ui/table/SortOrder','./Utils','sap/ui/rta/FlexAdapter','./ModelConverter'],function(q,l,C,L,a,D,T,b,c,S,d,N,H,V,e,J,f,B,g,F,h,j,U,k,M){"use strict";var m=C.extend("sap.ui.rta.FieldRepository",{metadata:{library:"sap.ui.rta",properties:{},associations:{"rootControl":{type:"sap.ui.core.Control"}},events:{"opened":{},"closed":{},"openCustomField":{}}}});m.prototype.init=function(){this._aData=[];this._aSupportedControls=[sap.ui.comp.smartform.SmartForm,sap.ui.comp.smartform.Group];this._oModel=new J();this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");this._bAscendingSortOrder=true;var o=new B({text:this._oRb.getText("BTN_FREP_OK"),press:[this.closeDialog,this]});this._oCustomFieldButton=new B({text:this._oRb.getText("BTN_FREP_CCF"),enabled:false,press:[this._redirectToCustomFieldCreation,this]});this._oInput=new f({width:"100%",liveChange:[this._updateModelFilter,this]}).addStyleClass("resourceListIF");var r=new L({icon:"sap-icon://sort"}).attachBrowserEvent("mousedown",q.proxy(this._resortTable,this));this.oInputFields=new g({content:[this._oInput,r]});var i=new L({design:a.Bold,tooltip:"{quickInfo}",text:"{fieldLabel}"});var n=new L({design:a.Standard,tooltip:"{quickInfo}",text:"{entityName}"});var p=new e({content:[i,n]});var s=new V({content:[p]});var t=new b({change:[this._fnSelected,this]}).bindProperty("checked","checked");this._oTable=new c({selectionMode:S.None,selectionBehavior:d.RowOnly,selectedIndex:-1,columnHeaderVisible:false,columns:[{template:t,width:"15%",hAlign:H.Center},{template:s,width:"85%",sortProperty:"fieldLabel",hAlign:H.Left}]});this._oModel.setData({modelData:this._aData});this._oTable.setModel(this._oModel);this._oTable.bindRows("/modelData");this._oTable.sort(this._oTable.getColumns()[1],(this._bAscendingSortOrder)?j.Ascending:j.Descending);this._oDialog=new D({title:this._oRb.getText("HEADER_FREP"),buttons:[this._oCustomFieldButton,o],content:[this.oInputFields,this._oTable],width:"400px",modal:true,closed:[this._revertChanges,this]}).addStyleClass("sapUIRtaFieldRepositoryDialog");this._oDialog.setInitialFocus(this._oInput);};m.prototype._resortTable=function(E){this._bAscendingSortOrder=!this._bAscendingSortOrder;this._oTable.sort(this._oTable.getColumns()[1],(this._bAscendingSortOrder)?j.Ascending:j.Descending);};m.prototype._redirectToCustomFieldCreation=function(E){this.fireOpenCustomField();this._oDialog.close();};m.prototype.setShowCreateCustomField=function(s){this._oCustomFieldButton.setEnabled(s);};m.prototype._updateModelFilter=function(E){var v=E.getParameter("newValue");var o=this._oTable.getBinding("rows");if(v!==""){var i=new F("fieldLabel",h.Contains,v);var n=new F("quickInfo",h.Contains,v);var p=new F({filters:[i,n],and:false});o.filter([p]);}else{o.filter([]);}};m.prototype._revertChanges=function(){for(var i=0;i<this._aChangeData.length;i++){var o=this._aChangeData[i];if(o.controlId){var n=sap.ui.getCore().byId(o.controlId);if(o.changeType==="hideControl"){this._oFlexAdapter.emitHideEvent(n);}else{this._oFlexAdapter.emitUnhideEvent(n);}}}this._oCurrentSelectedBlock.rerender();this._oDialog.close();};m.prototype.closeDialog=function(){this._aChangeData=[];this._oDialog.close();};m.prototype._fnSelected=function(E){var o=this._createChangeData(E.getSource(),E.mParameters.checked);if(o.exists){this._oFlexAdapter.emitUnhideEvent(sap.ui.getCore().byId(o.newControlId));}else if(o.selectorId&&o.changeType===k.M_TYPES.addField){this._oFlexAdapter.emitAddEvent(o,k.M_TYPES.addField);}else if(!E.mParameters.checked){this._oFlexAdapter.emitHideEvent(sap.ui.getCore().byId(o.controlId));}};m.prototype._createChangeData=function(o,s){var i={};var n=o.getBindingContext().getObject();var p=n.controlId?n.controlId:this._oCurrentSelectedBlock.getId()+"_"+n.entityName+"_"+n.name;var r=n.complexTypeName?n.complexTypeName+"/"+n.name:n.name;if(s){var t=sap.ui.getCore().byId(p);if(this._oCurrentSelectedBlock){var G;if(this._oCurrentSelectedBlock instanceof sap.ui.comp.smartform.Group){G=this._oCurrentSelectedBlock;}else{G=this._oCurrentSelectedBlock.getGroups()[0];}i={exists:t,newControlId:p,jsType:"sap.ui.comp.smartfield.SmartField",selectorId:G.getId(),index:G.getGroupElements().length+1,valueProperty:"value",changeType:k.M_TYPES.addField,fieldLabel:n.fieldLabel,fieldValue:r};}this._aChangeData.push({controlId:p,changeType:"hideControl"});}else{i={controlId:p,changeType:"unhideControl"};this._aChangeData.push(i);}return i;};m.prototype.open=function(o){var t=this;this._aChangeData=[];if(!this._oFlexAdapter){this._oFlexAdapter=new k();this._oFlexAdapter.init(sap.ui.getCore().byId(this.getRootControl()));}this._oCurrentSelectedControl=o;this._oCurrentSelectedBlock=U.findSupportedBlock(o,this._aSupportedControls);if(t._oCurrentSelectedBlock){t._createRepositoryFields(t._oCurrentSelectedBlock);t._oDialog.oPopup.attachOpened(function(){t.fireOpened();});t._oDialog.open();}};m.prototype._getIgnoredFields=function(s){if(s){var i=s.getIgnoredFields();if(i){var I=i.split(",");return I;}}return[];};m.prototype._createRepositoryFields=function(o){var E=[];var o=U.getClosestTypeForControl(o,"sap.ui.comp.smartform.SmartForm");var t=this;E=o.getEntityType();if(E){E=E.replace(/\s+/g,'').match(/([^,]+)/g);}M.getConvertedModelWithBoundAndRenamedLabels(o,E).then(function(i){t._oModel.setData({modelData:i});});};m.prototype.close=function(){var t=this;this._oDialog.close();this._oDialog.attachClosed(function(){t.fireClosed();});};return m;},true);
