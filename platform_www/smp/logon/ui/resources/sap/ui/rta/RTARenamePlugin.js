/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/dt/Plugin','sap/ui/dt/ElementUtil','sap/ui/dt/OverlayUtil','./Utils','sap/ui/fl/FlexControllerFactory'],function(q,P,E,O,U,F){"use strict";var R=P.extend("sap.ui.rta.RTARenamePlugin",{metadata:{library:"sap.ui.rta",properties:{},associations:{},events:{"editable":{},"nonEditable":{}}}});R.prototype.exit=function(){P.prototype.exit.apply(this,arguments);q(document).off("keydown",this._fnOnKeyDown);delete this._fnOnKeyDown;delete this._aSelection;};R.prototype.setDesignTime=function(d){this._aSelection=[];var o=this.getDesignTime();if(o){o.detachSelectionChange(this._onDesignTimeSelectionChange,this);}P.prototype.setDesignTime.apply(this,arguments);if(d){d.attachSelectionChange(this._onDesignTimeSelectionChange,this);this._aSelection=d.getSelection();}};R.prototype.registerOverlay=function(o){o.attachEvent("editableChange",this._manageClickEvent,this);if(this.checkEditable(o)){o.setEditable(true);}};R.prototype.deregisterOverlay=function(o){o.detachEvent("editableChange",this._manageClickEvent,this);o.detachBrowserEvent("click",this._onClick,this);};R.prototype._onClick=function(e){var o=sap.ui.getCore().byId(e.currentTarget.id);this.setEditMode(o);e.preventDefault();};R.prototype.setEditMode=function(o){this._oEditedOverlay=o;this._hideOverlays(true,{currentTarget:{id:o.getId()}});};R.prototype._hideOverlays=function(h,e){var t=sap.ui.getCore().byId(e.currentTarget.id);var $;var r={};if(!h){r={value:t.$()[0].innerText,type:this._oEditedOverlay.getElementInstance().getMetadata().getName()};$=t.$();q("#overlay-container").show();$.removeAttr("contenteditable");if($.hasClass("sapUiRtaEditLabel")){$.removeClass("sapUiRtaEditLabel");}else{$.removeClass("sapUiRtaEditTitle");}$[0].blur();$[0].onfocus=null;$[0].onblur=null;$[0].onkeydown=null;this.fireNonEditable();}else{var $=this._getTargetFor(t);q("#overlay-container").hide();$.attr("contenteditable","true");if($.hasClass("sapMLabel")){$.addClass("sapUiRtaEditLabel");}else{$.addClass("sapUiRtaEditTitle");}setTimeout(function(){$[0].focus();},0);$[0].onfocus=q.proxy(this._onEditableElementFocus,this);$[0].onblur=q.proxy(this._onEditableElementBlur,this);$[0].onkeydown=q.proxy(this._onEditableElementKeydown,this);this._oOldFieldValue=$[0].innerText;this.fireEditable();}return r;};R.prototype._getTargetFor=function(t){var n=t.getElementInstance().getMetadata().getName();var $;switch(n){case"sap.ui.comp.smartform.Group":$=t.getElementInstance().getTitle().$();break;case"sap.ui.comp.smartform.GroupElement":$=t.getElementInstance().getLabel().$();break;default:break;}return $;};R.prototype._createRenameEventInSmartForm=function(t,o){var e=o.getElementInstance();var T=o.getParentElementOverlay().getElementInstance();var p=o.getParentAggregationOverlay().getAggregationName();var s=this._oSourceParent.getId();var a=T.getId();var i=this._getIndexInParentAggregation(T,p,e);var c={changeType:t,selector:{id:s},targetId:a!==s?a:null};c[t]=[{id:e.getId(),index:i}];return{element:this._oSourceParent,change:c};};R.prototype._onDesignTimeSelectionChange=function(e){var t=this;var s=e.getParameter("selection");s.forEach(function(o){if(t._aSelection.indexOf(o)===-1){t._aSelection.push(o);}});t._aSelection.forEach(this._manageClickEvent,this);};R.prototype._manageClickEvent=function(e){var o=e.getSource?e.getSource():e;if(o.isSelected()&&o.isEditable()&&o.isDraggable()){o.attachBrowserEvent("click",this._onClick,this);}else{o.detachBrowserEvent("click",this._onClick,this);}};R.prototype.checkEditable=function(o){return U.isOverlayMutable(o);};R.prototype._onEditableElementKeydown=function(e){if(e.keyCode===q.sap.KeyCodes.ENTER){e.preventDefault();var c=this._hideOverlays(false,e);this._applyChange(e,c);}else if(e.keyCode===q.sap.KeyCodes.ESCAPE){e.preventDefault();this._oEditedOverlay.setSelected(true);this._hideOverlays(false,e);var t=sap.ui.getCore().byId(e.currentTarget.id);t.getDomRef().innerText=this._oOldFieldValue;}};R.prototype._onEditableElementBlur=function(e){var t=this._oEditedOverlay;setTimeout(function(){t.setSelected(true);t.focus();},0);var c=this._hideOverlays(false,e);if(c){var s=window.getSelection();s.removeAllRanges();this._applyChange(e,c);}};R.prototype._applyChange=function(e,c){if(this._oOldFieldValue!=c.value){var i=this._oEditedOverlay.getElementInstance().getId();var C=sap.ui.getCore().byId(i);var f=F.createForControl(C);var o=this._createLabelChange(i,c.value,c.type);f.createAndApplyChange(o,C);f.saveAll();}};R.prototype._onEditableElementFocus=function(e){var a=e.target;var r=document.createRange();r.selectNodeContents(a);var s=window.getSelection();s.removeAllRanges();s.addRange(r);};R.prototype._createLabelChange=function(i,l,t){var L={};L.selector={};L.selector.id=i;switch(t){case"form":L={};break;case"sap.ui.comp.smartform.Group":L.changeType="renameGroup";L.groupLabel=l;break;case"sap.ui.comp.smartform.GroupElement":L.changeType="renameField";L.fieldLabel=l;break;default:L={};break;}return L;};return R;},true);
