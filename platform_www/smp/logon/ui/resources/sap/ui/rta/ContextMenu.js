/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/unified/Menu','sap/ui/unified/MenuItem','sap/ui/core/Popup','sap/ui/dt/ElementUtil','./Utils','sap/ui/comp/smartform/GroupElement','sap/ui/comp/smartform/Group','sap/ui/comp/smartform/SmartForm'],function(q,l,M,a,P,E,U,G,b,S){"use strict";var C=M.extend("sap.ui.rta.ContextMenu",{metadata:{library:"sap.ui.rta",associations:{element:{type:"sap.ui.core.Element",multiple:false}},events:{renameLabel:{},hideElement:{},addElement:{},addGroup:{},adaptElement:{}}},renderer:{}});C.prototype.init=function(){M.prototype.init.apply(this,arguments);this.attachItemSelect(this._onItemSelected,this);this._oTextResources=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");this._fnOnKeyDown=this._onKeyDown.bind(this);q(document).keydown(this._fnOnKeyDown);this.attachBrowserEvent("contextmenu",this._onContextMenu,this);this._oOverlayDomRef=document.body;};C.prototype.exit=function(){M.prototype.exit.apply(this,arguments);this._oRb=null;q(document).off("keydown",this._fnOnKeyDown);delete this._fnOnKeyDown;this.detachBrowserEvent("contextmenu");};C.prototype.setOverlayDomRef=function(o){this._oOverlayDomRef=o.getDomRef();};C.prototype.getElementInstance=function(){return sap.ui.getCore().byId(this.getElement());};C.prototype.setElement=function(e){this.setAssociation("element",e,true);var m=[];var o=this.getElementInstance();if(o instanceof G){m.push({text:"CTX_RENAME_LABEL",enabled:true});m.push({text:"CTX_ADD_FIELD",enabled:true});var h=U.hasGroupElementBoundFields(o);m.push({text:"CTX_HIDE_FIELD",enabled:h});m.push({text:"CTX_ADAPT",startSection:true,enabled:true});}if(o instanceof b){m.push({text:"CTX_RENAME_GROUP",enabled:true});m.push({text:"CTX_ADD_FIELD",enabled:true});m.push({text:"CTX_ADD_GROUP",enabled:true});var H=U.hasGroupUnBoundFields(o);m.push({text:"CTX_HIDE_GROUP",enabled:!H});m.push({text:"CTX_ADAPT",startSection:true,enabled:true});}if(o instanceof S){m.push({text:"CTX_ADD_GROUP",enabled:true});m.push({text:"CTX_ADAPT",enabled:true});}this._createMenuItems(m);};C.prototype._createMenuItems=function(m){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");this.destroyItems();for(var i=0;i<m.length;i++){var o=new a({text:this._oRb.getText(m[i].text),enabled:m[i].enabled});o.data({id:m[i].text});if(m[i].startSection){o.setStartsSection(true);}this.addItem(o);}};C.prototype._getSmartFormForElement=function(e){while(e&&!E.isInstanceOf(e,"sap.ui.comp.smartform.SmartForm")){e=e.getParent();}return e;};C.prototype._onItemSelected=function(e){var i=e.getParameter("item").data("id");var o=this.getElementInstance();switch(i){case"CTX_ADD_FIELD":this.fireAddElement({element:o});break;case"CTX_ADD_GROUP":this.fireAddGroup({element:o});break;case"CTX_RENAME_LABEL":case"CTX_RENAME_GROUP":this.fireRenameLabel({element:o});break;case"CTX_HIDE_FIELD":case"CTX_HIDE_GROUP":this.fireHideElement({element:o});break;case"CTX_ADAPT":var s=this._getSmartFormForElement(o);this.fireAdaptElement({element:s});break;default:break;}};C.prototype._onOpenCustomField=function(e){var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var h=(c&&c.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:this._oCurrentFieldExtInfo.BusinessContexts,serviceName:this._oCurrentFieldExtInfo.ServiceName,serviceVersion:this._oCurrentFieldExtInfo.ServiceVersion}}));window.open(h,"_blank");};C.prototype._open=function(p,i){if(this.getItems().length===0){return;}var m=p;var c=i;var X=m;var Y=c;var d=q('body').width();var e=q('body').height();if(!this.getDomRef()){this.open(false,undefined,undefined,undefined,undefined,-2000+" "+-2000,"none");}var f=this.$().context.clientWidth;var g=this.$().context.clientHeight;var x=(d-m<f)?f:0;var y=(e-c<g)?g:0;X=((d/2-m)*-1)+f/2+2-x;Y=((e/2-c)*-1)+g/2+2-y;var h=c-g;if(h<0&&y!==0){Y=Y-h;}this.close();this.open(true,this._oOverlayDomRef,undefined,undefined,document.body,X+" "+Y,"flip");};C.prototype.openMenu=function(c){this._open(c.pageX,c.pageY);};C.prototype._onKeyDown=function(e){if(!this.bOpen){q(document).off("keydown",this._fnOnKeyDown);delete this._fnOnKeyDown;return;}if((e.keyCode===q.sap.KeyCodes.F10)&&(e.shiftKey===true)&&(e.altKey===false)&&(e.ctrlKey===false)){e.preventDefault();}};C.prototype._onContextMenu=function(e){if(!this.bOpen){this.detachBrowserEvent("contextmenu");return;}if(e.preventDefault){e.preventDefault();}};return C;},true);
