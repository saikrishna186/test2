/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","./Loco","./ViewportHandler"],function(q,l,C,R,L,V){"use strict";var N=C.extend("sap.ui.vk.NativeViewport",{metadata:{library:"sap.ui.vk",publicMethods:["beginGesture","endGesture","pan","rotate","zoom","tap","queueCommand","getViewInfo","setViewInfo","loadUrl"],events:{"resize":{parameters:{oldSize:"object",size:"object"}},"move":{parameters:{pan:"object",zoom:"float"}}}},init:function(){if(C.prototype.init){C.prototype.init(this);}this._canvas=null;this._canvas=document.createElement("div");this._canvas.style.overflow="none";this._canvas.style.width="100%";this._canvas.style.height="100%";this._canvas.id=q.sap.uid();this._resizeListenerId=null;this._viewportHandler=new V(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._img=null;this._reset();this._gx=0;this._gy=0;this._imageW=0;this._imageH=0;},exit:function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();this._inputDevice.disable();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}if(C.prototype.exit){C.prototype.exit.apply(this);}},onBeforeRendering:function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}},onAfterRendering:function(){if(this._canvas){var d=this.getDomRef();d.appendChild(this._canvas);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._bestFit();this._handleResize({size:{width:d.clientWidth,height:d.clientHeight}});}},_handleResize:function(e){this.fireResize({oldSize:e.oldSize,size:e.size});this._update();},_reset:function(){this._x=0;this._y=0;this._s=1.0;this._r=0;},_update:function(){if(this._img!=null){var x=this._x-(this._imageW-this._canvas.clientWidth)/2;var y=this._y-(this._imageH-this._canvas.clientHeight)/2;var t="matrix("+this._s+",0,0,"+this._s+","+x+","+y+")";this._img.style.transform=t;this._img.style.webkitTransform=t;this._img.style.msTransform=t;this._img.style.MozTransform=t;this._img.style.OTransform=t;}},_bestFit:function(){this._reset();var s=this._canvas.clientWidth/this._imageW;var a=this._canvas.clientHeight/this._imageH;this._s=s<a?s:a;if(this._s==0){this._s=1.0;}this._x=0;this._y=0;this._update();},loadUrl:function(u,o,a,b,r){if(/^(jpg|png|gif)$/.test(r)==false){q.sap.log.error("Unsupported content resource type "+r);return this;}while(this._canvas.lastChild){this._canvas.removeChild(this._canvas.lastChild);}this._reset();this._img=new Image();this._img.onload=function(){this._imageW=this._img.width;this._imageH=this._img.height;this._canvas.appendChild(this._img);this._bestFit();o();}.bind(this);this._img.onerror=function(){a();};this._img.src=u;return this;},beginGesture:function(x,y){this._gx=(x-this._canvas.clientWidth/2-this._x)/this._s;this._gy=(y-this._canvas.clientHeight/2-this._y)/this._s;return this;},endGesture:function(){this._gx=0;this._gy=0;return this;},pan:function(d,a){this._x+=d;this._y+=a;this._update();this.fireMove({pan:{x:d,y:a},zoom:1.0});return this;},rotate:function(d,a){this._x+=d;this._y+=a;this._update();this.fireMove({pan:{x:d,y:a},zoom:1.0});return this;},zoom:function(z){var g=this._gx*this._s;var a=this._gy*this._s;this._s*=z;var b=this._gx*this._s;var c=this._gy*this._s;var d=g-b;var e=a-c;this._x+=d;this._y+=e;this._update();this.fireMove({pan:{x:d,y:e},zoom:z});return this;},tap:function(x,y,i){if(i){this._bestFit();}return this;},queueCommand:function(c){c();return this;},getViewInfo:function(){var v={};v.camera=[this._s,0,0,this._s,this._x,this._y];return v;},setViewInfo:function(v){var c=v.camera;this._s=c[0];this._x=c[4];this._y=c[5];this._update();return this;}});return N;});
