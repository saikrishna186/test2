/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/base/EventProvider"],function(q,l,E){"use strict";var D=E.extend("sap.ui.vk.DownloadManager",{metadata:{publicMethods:["start","attachItemSucceeded","detachItemSucceeded","attachItemFailed","detachItemFailed","attachAllItemsCompleted","detachAllItemsCompleted"],events:{itemSucceeded:{parameters:{source:{type:"any"},response:{type:"object"}}},itemFailed:{parameters:{source:{type:"any"},status:{type:"any"},statusText:{type:"string"}}},allItemsCompleted:{}}},constructor:function(s,m){E.apply(this);this._maxParallelTasks=m||5;this._sourcesToProcess=s.slice();this._sourcesBeingProcessed=[];},start:function(){while(this._pickAndDispatchTask()){}return this;},_pickAndDispatchTask:function(){if(this._sourcesToProcess.length>0&&this._sourcesBeingProcessed.length<this._maxParallelTasks){var s=this._sourcesToProcess.shift();this._sourcesBeingProcessed.push(s);this._runTask(s);return true;}return false;},_taskFinished:function(s){var i=this._sourcesBeingProcessed.indexOf(s);if(i>=0){this._sourcesBeingProcessed.splice(i,1);}return this._sourcesToProcess.length===0&&this._sourcesBeingProcessed.length===0;},_runTask:function(s){var t=this;if(typeof s==="string"){var x=new XMLHttpRequest();x.onreadystatechange=function(e){if(x.readyState===x.DONE){var i=t._taskFinished(s);t._pickAndDispatchTask();if(x.status===200){t.fireItemSucceeded({source:s,response:x.response});}else{t.fireItemFailed({source:s,status:x.status,statusText:x.statusText});}if(i){t.fireAllItemsCompleted({});}}};x.open("GET",s,true);x.responseType="arraybuffer";x.send(null);}else if(s instanceof File){var f=new FileReader();f.onload=function(e){var i=t._taskFinished(s);t._pickAndDispatchTask();t.fireItemSucceeded({source:s,response:f.result});if(i){t.fireAllItemsCompleted({});}};f.onerror=function(e){var i=t._taskFinished(s);t._pickAndDispatchTask();t.fireItemFailed({source:s,status:f.error.name,statusText:f.error.message});if(i){t.fireAllItemsCompleted({});}};f.readAsArrayBuffer(s);}else{throw new Error("Unsupported type of the 'source' parameter");}return this;},attachItemSucceeded:function(d,f,a){return this.attachEvent("itemSucceeded",d,f,a);},detachItemSucceeded:function(f,a){return this.detachEvent("itemSucceeded",f,a);},fireItemSucceeded:function(p,a,e){return this.fireEvent("itemSucceeded",p,a,e);},attachItemFailed:function(d,f,a){return this.attachEvent("itemFailed",d,f,a);},detachItemFailed:function(f,a){return this.detachEvent("itemFailed",f,a);},fireItemFailed:function(p,a,e){return this.fireEvent("itemFailed",p,a,e);},attachAllItemsCompleted:function(d,f,a){return this.attachEvent("allItemsCompleted",d,f,a);},detachAllItemsCompleted:function(f,a){return this.detachEvent("allItemsCompleted",f,a);},fireAllItemsCompleted:function(p,a,e){return this.fireEvent("allItemsCompleted",p,a,e);}});return D;});
