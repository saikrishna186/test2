/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control','sap/ui/core/IconPool','sap/ui/thirdparty/jqueryui/jquery-ui-widget','sap/ui/thirdparty/jqueryui/jquery-ui-core','sap/ui/thirdparty/jqueryui/jquery-ui-mouse','sap/ui/thirdparty/jqueryui/jquery-ui-draggable','sap/ui/vbm/lib/sapvbi'],function(q,l,C,I,j,a,b,c,d){"use strict";var O=C.extend("sap.ui.vk.Overlay",{metadata:{library:"sap.ui.vk",properties:{zoomOnResize:{type:"boolean",group:"Behavior",defaultValue:true}},aggregations:{areas:{type:"sap.ui.vk.OverlayArea",multiple:true,singularName:"area"}},associations:{target:{type:"sap.ui.core.Control",cardinality:"0..1"}},events:{click:{parameters:{clientX:{type:"int"},clientY:{type:"int"},pos:{type:"string"}}},contextMenu:{parameters:{pos:{type:"string"},menu:{type:"sap.ui.unified.Menu"}}}}}});O.prototype.getPositionInteractive=function(p,e){if(!this.mIACreateCB&&e&&typeof(e)==="function"){this.mIACreateCB=e;var t="POS";if(p){t+="ARRAY";}var L={"SAPVB":{"Automation":{"Call":{"handler":"OBJECTCREATIONHANDLER","name":"CreateObject","object":"MainScene","scene":"MainScene","instance":"","Param":{"name":"data","#":"{"+t+"}"}}}}};this._load(L);return true;}else{return false;}};O.prototype.openContextMenu=function(m){this._openContextMenu("Overlay",this,m);};O.prototype.init=function(){this.aLoadQueue=null;this.oTargetDomRef=null;this.mVBIContext=new VBI.VBIContext(this);this.resizeID="";this.bVosDirty=true;this.bWindowsDirty=true;this.bSceneDirty=true;this.bDataDeltaUpdate=false;this.bHandleDataChangeActive=false;this.bForceDataUpdate=false;this.mAddMenuItems=[];};O.prototype.exit=function(){if(this.mVBIContext){this.mVBIContext.clear();}if(this.resizeID!=""){sap.ui.core.ResizeHandler.deregister(this.resizeID);this.resizeID="";}};O.prototype.resize=function(e){var f=(this.oControl!=undefined)?this.oControl:this;var g=f.mVBIContext;if(g){var s=g.GetMainScene();if(s){if(f.getZoomOnResize()&&e&&e.oldSize.width>0){var z=Math.log2(e.size.width/e.oldSize.width);s.ZoomToGeoPosition(s.GetCenterPos(),s.GetCurrentZoomlevel()+z,false,true,true);}s.resizeCanvas(e,true,true);}}f._adaptSizeOfTarget();};O.prototype.setTarget=function(t){var e=this;this.setAssociation("target",t);if(t instanceof sap.m.Image){t.addEventDelegate({onAfterRendering:function(E){e.oTargetDomRef=t.getDomRef();e.oTargetDomRef.addEventListener("load",q.proxy(e._adaptSizeOfTarget,e));}});}if(t instanceof sap.ui.vk.NativeViewport){t.addEventDelegate({onAfterRendering:function(E){e.oTargetDomRef=t.getDomRef();e._adaptSizeOfTarget();}});}};O.prototype._adaptSizeOfTarget=function(){var t=this.oTargetDomRef;var f=this.getDomRef();if(t){try{var T=q(t);var p={top:T.offset().top,left:T.offset().left,width:T.outerWidth(),height:T.outerHeight()};q(f).width(p.width).height(p.height).css("position","absolute");q(f).css("top","0px").css("left","0px").css("visibility","");}catch(e){q.sap.log.error(e);}q(f).insertAfter(t);}else{q(f).css("position","fixed").width("0px").height("0px").css("top","0px").css("left","0px").css("visibility","hidden");}};O.prototype.onAfterRendering=function(){if(this.$oldContent.length>0){this.$().append(this.$oldContent);}this._adaptSizeOfTarget();if(this.aLoadQueue){var n;for(n=0;n<this.aLoadQueue.length;++n){this._load(this.aLoadQueue[n]);}this.aLoadQueue=null;}if(this.resizeID==""){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}var o=this.getId();if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(o);}};O.prototype.onBeforeRendering=function(){this.$oldContent=sap.ui.core.RenderManager.findPreservedContent(this.getId());};O.prototype.invalidate=function(s){this.bSceneDirty=true;if(s instanceof sap.ui.vk.OverlayArea){this.bVosDirty=true;this.bDataDeltaUpdate=this.bHandleDataChangeActive;}sap.ui.core.Control.prototype.invalidate.apply(this,arguments);};O.prototype._load=function(e){if(!this.isRendered()){if(!this.aLoadQueue){this.aLoadQueue=[];}this.aLoadQueue.push(e);return;}this._loadHtml(e);};O.prototype._loadHtml=function(e){var o=this.getId();var f=null;if(typeof e=='string'){f=JSON.parse(e.indexOf('{')?e.substr(e.indexOf('{')):e);}else if(typeof e=='object'){f=e;}if(!f){return;}if(!f["SAPVB"]){var m;if(this.mVBIContext&&(m=(new VBI.Adaptor(this.mVBIContext)).CreateLoadData(f))){this.loadHtml(m);return;}else{return;}}var M=false;var g=false;var h=false;if(q.type(f)=='object'){if(f.SAPVB){if(f.SAPVB.Config){this.mVBIContext.GetConfig().load(f.SAPVB.Config,this.mVBIContext);}if(f.SAPVB.Resources){this.mVBIContext.GetResources().load(f.SAPVB.Resources,this.mVBIContext);}if(f.SAPVB.DataTypes){if(!this.mVBIContext.m_DataTypeProvider){this.mVBIContext.m_DataTypeProvider=new VBI.DataTypeProvider();}this.mVBIContext.m_DataTypeProvider.load(f.SAPVB.DataTypes,this.mVBIContext);}if(f.SAPVB.Data){if(!this.mVBIContext.m_DataProvider){this.mVBIContext.m_DataProvider=new VBI.DataProvider();}this.mVBIContext.m_DataProvider.load(f.SAPVB.Data,this.mVBIContext);M=true;}if(f.SAPVB.Windows){if(!this.mVBIContext.m_Windows){this.mVBIContext.m_Windows=new VBI.Windows();}this.mVBIContext.m_Windows.load(f.SAPVB.Windows,this.mVBIContext);h=true;}if(f.SAPVB.Actions){if(!this.mVBIContext.m_Actions){this.mVBIContext.m_Actions=new VBI.Actions();}this.mVBIContext.m_Actions.load(f.SAPVB.Actions,this.mVBIContext);}if(f.SAPVB.Automation){if(!this.mVBIContext.m_Automations){this.mVBIContext.m_Automations=new VBI.Automations();}this.mVBIContext.m_Automations.load(f.SAPVB.Automation,this.mVBIContext);}if(f.SAPVB.Menus){if(!this.mVBIContext.m_Menus){this.mVBIContext.m_Menus=new VBI.Menus();}this.mVBIContext.m_Menus.load(f.SAPVB.Menus,this.mVBIContext);}if(f.SAPVB.Scenes){if(!this.mVBIContext.m_SceneManager){this.mVBIContext.m_SceneManager=new VBI.SceneManager();}this.mVBIContext.m_SceneManager.load(f.SAPVB.Scenes,this.mVBIContext);g=true;}}if(M){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.NotifyDataChange();}}if(g||h){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(o);}}if(g||M){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.RenderAsync();}}}};O.prototype._openContextMenu=function(t,i,m){if(m&&m.vbi_data&&m.vbi_data.VBIName=="DynContextMenu"){if(!this.mVBIContext.m_Menus){this.mVBIContext.m_Menus=new window.VBI.Menus();}for(var n=0;n<this.mAddMenuItems.length;++n){m.addItem(this.mAddMenuItems[n]);}this.mVBIContext.m_Menus.m_menus.push(m);this._loadHtml({"SAPVB":{"version":"2.0","Automation":{"Call":{"earliest":"0","handler":"CONTEXTMENUHANDLER","instance":i.sId,"name":"SHOW","object":t,"refID":"CTM","Param":[{"name":"x","#":i.mClickPos[0]},{"name":"y","#":i.mClickPos[1]},{"name":"scene","#":"MainScene"}]}}}});}this.mAddMenuItems=[];};O.prototype._update=function(){var A={SAPVB:{}};if(this.bSceneDirty){this._updateScene(A);}this._updateWindows(A);if(A.SAPVB.Actions){Array.prototype.push.apply(A.SAPVB.Actions.Set.Action,this._getActionArray());}return this._minimizeApp(A);};O.prototype._minimizeApp=function(A){var t,s;s=null;if(!this.bWindowsDirty){(t=A)&&(t=t.SAPVB)&&(t=t.Windows)&&(s=JSON.stringify(t))&&(s==this.mCurWindows)&&(delete A.SAPVB.Windows)||(this.mCurWindows=s?s:this.mCurWindows);}else{this.bWindowsDirty=false;}s=null;(t=A)&&(t=t.SAPVB)&&(t=t.Scenes)&&(s=JSON.stringify(t))&&(s==this.mCurScenes)&&(delete A.SAPVB.Scenes)||(this.mCurScenes=s?s:this.mCurScenes);s=null;(t=A)&&(t=t.SAPVB)&&(t=t.Actions)&&(s=JSON.stringify(t))&&(s==this.mCurActions)&&(delete A.SAPVB.Actions)||(this.mCurActions=s?s:this.mCurActions);s=null;(t=A)&&(t=t.SAPVB)&&(t=t.DataTypes)&&(s=JSON.stringify(t))&&(s==this.mCurDataTypes)&&(delete A.SAPVB.DataTypes)||(this.mCurDataTypes=s?s:this.mCurDataTypes);if(!this.bForceDataUpdate){s=null;(t=A)&&(t=t.SAPVB)&&(t=t.Data)&&(s=JSON.stringify(t))&&(s==this.mCurData)&&(delete A.SAPVB.Data)||(this.mCurData=s?s:this.mCurData);}else{this.bForceDataUpdate=false;}return A;};O.prototype._updateWindows=function(A){A.SAPVB.Windows={"Set":[{"name":"Main","Window":{"id":"Main","caption":"MainWindow","type":"geo","refParent":"","refScene":"MainScene","modal":"true"}}]};};O.prototype._updateScene=function(A){var s=[];var e=[];var f=[];var g=[];this._updateVOData(s,e,f,g);var _=JSON.stringify(s);var m=true;if(!this.saVO){((((A.SAPVB.Scenes={}).Set={}).SceneGeo={id:"MainScene",scaleVisible:"false",navControlVisible:"false",VisualFrame:{minLOD:6,maxLOD:14},NavigationDisablement:{move:"true",zoom:"true"},initialZoom:"10",initialStartPosition:"0.5;0.5;0"}).VO=s);}else if(this.bRefMapLayerStackDirty||!(this.saVO===_)){(A.SAPVB.Scenes=this._getSceneVOdelta(JSON.parse(this.m_saVO),s));}else{m=false;}this.saVO=_;if(this.bDataDeltaUpdate){A.SAPVB.Data=[];for(var n=0;n<e.length;++n){A.SAPVB.Data.push({Set:{name:e[n].name,type:"N",N:e[n]}});}}else{((A.SAPVB.Data={}).Set={}).N=e;}if(m){(((A.SAPVB.DataTypes={}).Set={}).N=f);}if(m){(((A.SAPVB.Actions={}).Set={}).Action=g);}this.bSceneDirty=this.bVosDirty=this.bDataDeltaUpdate=false;};O.prototype._isEventRegistered=function(A,e){var f=this.getAggregation(A);if(!f){return false;}for(var n=0;n<f.length;++n){var i=f[n];if(i.hasListeners(e)){return true;}}return false;};O.prototype._getTemplateBindingInfo=function(A){var B=this.getBindingInfo(A);if(B&&B.template){return B.template.mBindingInfos;}};O.prototype._getBindInfo=function(A){var B={};var t=this._getTemplateBindingInfo(A);B.C=(t)?t.hasOwnProperty("color"):true;B.CB=(t)?t.hasOwnProperty("colorBorder"):true;B.DCH=(t)?t.hasOwnProperty("deltaColorHot"):true;B.CS=(t)?t.hasOwnProperty("colorSelect"):true;B.CNS=(t)?t.hasOwnProperty("colorNonSelect"):true;B.TT=(t)?t.hasOwnProperty("tooltip"):true;B.M=(t)?t.hasOwnProperty("changeable"):true;B.hasTemplate=(t)?true:false;return B;};O.prototype._updateVOData=function(s,e,f,g){var B,v;this.AreaBindInfo=B=(this.AreaBindInfo)?this.AreaBindInfo:this._getBindInfo("areas");v=(B.hasTemplate)?this.getBindingInfo("areas").template:null;var o={id:"OverlayArea",datasource:"OverlayArea",type:"{00100000-2012-0004-B001-F311DE491C77}"};o['posarray.bind']=o.id+".P";if(B.C){o['color.bind']=o.id+".C";}else{o.color=v.getColor();}if(B.CB){o['colorBorder.bind']=o.id+".C";}else{o.colorBorder=v.getColorBorder();}if(B.DCH){o['hotDeltaColor.bind']=o.id+".DCH";}else{o.hotDeltaColor=v.getDeltaColorHot();}if(B.CS){o['colorSelect.bind']=o.id+".C";}else{o.colorSelect=v.getColorSelect();}if(B.CNS){o['colorNonSelect.bind']=o.id+".C";}else{o.colorNonSelect=v.getColorNonSelect();}if(!B.M){o['VB:c']=v.getChangeable();}s.push(o);var h={name:o.id,key:'K'};h.A=[{"name":"K","alias":"K","type":"string"},{"name":"VB:s","alias":"VB:s","type":"boolean"},{"name":"P","alias":"P","type":"vectorarray","changeable":"true"}];if(B.C){h.A.push({"name":"C","alias":"C","type":"color"});}if(B.CB){h.A.push({"name":"CB","alias":"CB","type":"string"});}if(B.DCH){h.A.push({"name":"DCH","alias":"DCH","type":"string"});}if(B.CS){h.A.push({"name":"CS","alias":"CS","type":"string"});}if(B.CNS){h.A.push({"name":"CNS","alias":"CNS","type":"string"});}if(B.TT){h.A.push({"name":"TT","alias":"TT","type":"string"});}f.push(h);var i=o.id;if(this._isEventRegistered("areas","click")){g.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this._isEventRegistered("areas","contextMenu")){g.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});}if(this._isEventRegistered("areas","edgeClick")){g.push({"id":i+"7","name":"edgeClick","refScene":"MainScene","refVO":i,"refEvent":"EdgeClick"});}g.push({"id":i+"4","name":"handleMoved","refScene":"MainScene","refVO":i,"refEvent":"HandleMoved"});g.push({"id":i+"5","name":"handleContextMenu","refScene":"MainScene","refVO":i,"refEvent":"HandleContextMenu"});g.push({"id":i+"8","name":"edgeContextMenu","refScene":"MainScene","refVO":i,"refEvent":"EdgeContextMenu"});if(this._isEventRegistered("areas","handleClick")){g.push({"id":i+"6","name":"handleClick","refScene":"MainScene","refVO":i,"refEvent":"HandleClick"});}var k={name:o.id,E:[]};var m=this.getAreas();for(var n=0;n<m.length;++n){k.E.push(m[n].getDataElement());}e.push(k);};O.prototype._getSceneVOdelta=function(o,n){var v=[];var r=[];var V={};for(var e=0,f=o.length;e<f;++e){V[o[e].id]=o[e];}for(var g=0;g<n.length;++g){if(V[n[g].id]){if(JSON.stringify(n[g])!=JSON.stringify(V[n[g].id])){r.push({"id":n[g].id,"type":"VO"});v.push(n[g]);}}else{v.push(n[g]);}delete V[n[g].id];}for(var i in V){r.push({"id":i,"type":"VO"});}var h={"Merge":{"name":"MainScene","type":"SceneGeo","SceneGeo":{"id":"MainScene"}}};if(r.length){h.Merge.SceneGeo.Remove=r;}if(v.length){h.Merge.SceneGeo.VO=v;}return h;};O.prototype._getActionArray=function(){var A=[];if(this.mEventRegistry["click"]){A.push({"id":"Overlay1","name":"click","refScene":"MainScene","refVO":"Map","refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this.mEventRegistry["contextMenu"]){A.push({"id":"Overlay2","name":"contextMenu","refScene":"MainScene","refVO":"Map","refEvent":"ContextMenu","AddActionProperty":[{"name":"pos"}]});}A.push({"id":"Overlay3","name":"GetPosComplete","refScene":"MainScene","refVO":"General","refEvent":"CreateComplete"});return A;};O.prototype._handleChangedData=function(n){try{this.bHandleDataChangeActive=true;if(n&&n.length){for(var e=0,N;e<n.length;++e){N=n[e];if(N.E&&N.E.length){for(var f=0,E,i;f<N.E.length;++f){E=N.E[f];i=this._findInstance(E.K);if(i){i.handleChangedData(E);}}}}}this.bHandleDataChangeActive=false;}catch(g){this.bHandleDataChangeActive=false;throw g;}};O.prototype._findInstance=function(i){var e=(i.indexOf(".")!==-1)?i.split(".")[1]:i;var A=this.getAreas();for(var n=0;n<A.length;++n){var E=A[n];if(E.getId()===e){return E;}}return null;};O.prototype._handleAggregationEvent=function(e){var E;if((E=this._findInstance(e.Action.instance))){try{E.handleEvent(e);}catch(f){q.sap.log.error("Event handler failed: "+f.message);}}};O.prototype.isRendered=function(){return this.getDomRef()?true:false;};O.prototype.fireSubmit=function(e){var f=JSON.parse(e.data);if(f.Data&&f.Data.Merge){this._handleChangedData(f.Data.Merge.N);}if(f.Action.object==="OverlayArea"){this._handleAggregationEvent(f);}else{var A=f.Action.name,g;if(A==="click"||A==="contextMenu"){g=[f.Action.Params.Param[0]['#'],f.Action.Params.Param[1]['#']];}switch(A){case"GetPosComplete":if(this.mIACreateCB){try{this.mIACreateCB(f.Action.Params.Param[0]['#']);this.mIACreateCB=null;}catch(h){this.mIACreateCB=null;throw h;}}break;case"click":this.fireClick({clientX:g[0],clientY:g[1],pos:f.Action.AddActionProperties.AddActionProperty[0]['#']});break;case"contextMenu":q.sap.require("sap.ui.unified.Menu");if(this.mVBIContext.m_Menus){this.mVBIContext.m_Menus.deleteMenu("DynContextMenu");}var m=new sap.ui.unified.Menu();m.vbi_data={};m.vbi_data.menuRef="CTM";m.vbi_data.VBIName="DynContextMenu";this.mClickPos=g;this.fireContextMenu({pos:f.Action.AddActionProperties.AddActionProperty[0]['#'],menu:m});break;default:break;}}};O.prototype.fireRender=function(e){};O.prototype.fireMove=function(e){};O.prototype.fireZoom=function(e){};O.prototype.fireOpenWindow=function(e){};O.prototype.fireCloseWindow=function(e){};return O;});
