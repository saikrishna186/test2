/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","sap/m/MessageBox","sap/ui/layout/form/SimpleForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/m/Dialog","sap/ui/generic/app/util/ModelUtil","sap/m/VBox","sap/m/Text"],function(q,M,a,S,G,b,c,d,D,e,V,T){"use strict";var A=M.extend("sap.ui.generic.template.ActionUtil",{metadata:{properties:{controller:{type:"object",group:"Misc",defaultValue:null},context:{type:"object",group:"Misc",defaultValue:null},successCallback:{type:"function",group:"Misc",defaultValue:null}}}});A.prototype.call=function(f,F){this._sFunctionImportPath=f;var C=this.getController();if(!C){throw new Error("Controller not provided");}this._oMetaModel=C.getView().getModel().getMetaModel();var s=f.split('/')[1];this._oFunctionImport=this._oMetaModel.getODataFunctionImport(s);this._sFunctionImportLabel=F||s;if(!this._oFunctionImport){throw new Error("Unknown Function Import "+s);}if(this._isActionCritical()){var t=this;var m=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ACTION_CONFIRM");m=q.sap.formatMessage(m,this._sFunctionImportLabel);a.confirm(m,{title:this._sFunctionImportLabel,onClose:function(o){if(o==="OK"){t._prepareParameters();t._initiateCall();}},sClass:t._getCompactModeStyleClass()});}else{this._prepareParameters();this._initiateCall();}};A.prototype._getCompactModeStyleClass=function(){if(this.getController().getView().$().closest(".sapUiSizeCompact").length){return"sapUiSizeCompact";}return"";};A.prototype._isActionCritical=function(){var C=this._oFunctionImport["com.sap.vocabularies.Common.v1.IsActionCritical"];if(!C){return false;}if(C.Bool===undefined){return true;}return this._toBoolean(C.Bool);};A.prototype._toBoolean=function(p){if(typeof p==="string"){var v=p.toLowerCase();return!(v=="false"||v==""||v==" ");}return!!p;};A.prototype._prepareParameters=function(){this._oCurrentContext=this.getContext()||this._oView.getBindingContext();this._oContextObject=this._oCurrentContext.getObject();var E=this._getEntityType();var k=this._getPropertyKeys(E);var p;this._oParameters={parameterData:{},additionalParameters:[]};if(this._oFunctionImport.parameter){for(var i=0;i<this._oFunctionImport.parameter.length;i++){var P=this._oFunctionImport.parameter[i];this._addParameterLabel(P,E);var s=P.name;var I=!!k[s];p=undefined;if(this._oContextObject.hasOwnProperty(s)){p=this._oContextObject[s];}else if(I){q.sap.log.error("Key parameter of action not found in current context: "+s);throw new Error("Key parameter of action not found in current context: "+s);}this._oParameters.parameterData[s]=p;if(!I){this._oParameters.additionalParameters.push(P);}}}};A.prototype._getPropertyKeys=function(E){var k={};if(E&&E.key&&E.key.propertyRef){for(var i=0;i<E.key.propertyRef.length;i++){var K=E.key.propertyRef[i].name;k[K]=true;}}return k;};A.prototype._getEntityType=function(){var E=null;if(this._oCurrentContext&&this._oCurrentContext.getPath()){var s=e.getEntitySetFromContext(this._oCurrentContext);var o=this._oMetaModel.getODataEntitySet(s,false);E=this._oMetaModel.getODataEntityType(o.entityType,false);}return E;};A.prototype._initiateCall=function(){if(this._oParameters.additionalParameters.length>0){var p=new sap.ui.model.json.JSONModel();p.setData(this._oParameters.parameterData);var t=this;var P=this._buildParametersForm();var o=new D({title:this._sFunctionImportLabel,content:[P.form],beginButton:new sap.m.Button({text:this._sFunctionImportLabel,press:function(E){if(!P.checkClientErrors()){var m=t._getActionParameterData(E.getSource().getModel());if(m.missingMandatoryParameters.length==0){o.close();t._call(m.preparedParameterData);}else{var C=new V();var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ACTION_MISSING_MANDATORY");for(var i=0;i<m.missingMandatoryParameters.length;i++){var s=q.sap.formatMessage(r,t._getParameterName(m.missingMandatoryParameters[i]));C.addItem(new T({text:s}));}a.error(C,{sClass:t._getCompactModeStyleClass()});}}}}),endButton:new sap.m.Button({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.template").getText("ACTION_CANCEL"),press:function(){o.close();}}),afterClose:function(){o.destroy();}}).addStyleClass("sapUiNoContentPadding");o.addStyleClass(this._getCompactModeStyleClass());o.setModel(p);o.open();}else{this._call();}};A.prototype._call=function(u){var p={urlParameters:u};var C=this.getController();var o=this._oCurrentContext;var t=this;try{C.getTransactionController().invokeAction(this._sFunctionImportPath,this._oCurrentContext,p).then(function(r){var g=t.getSuccessCallback();if(g){g(r.context);}C.handleSuccess(r);},function(E){C.handleError(E,{context:o});});}catch(f){C.handleError(f,{context:o});}};A.prototype._getActionParameterData=function(p){var m=[];var r=p.getObject('/');var P={};for(var i=0;i<this._oFunctionImport.parameter.length;i++){var o=this._oFunctionImport.parameter[i];var s=o.name;if(r.hasOwnProperty(s)){var v=r[s];if(v===undefined){if(!this._toBoolean(o.nullable)){if(o.type==='Edm.Boolean'){P[s]=false;}else{m.push(o);}}}else{P[s]=v;}}else{throw new Error("Unknown parameter: "+s);}}return{preparedParameterData:P,missingMandatoryParameters:m};};A.prototype._buildParametersForm=function(){var f=new S({editable:true});var F=[];for(var i=0;i<this._oParameters.additionalParameters.length;i++){var p=this._oParameters.additionalParameters[i];var P=this._getParameterName(p);var B='{/'+p.name+'}';var j=null;var E=p.type;var m=p.maxLength?parseInt(p.maxLength,10):undefined;if(E==='Edm.String'){j=sap.ui.comp.smartfield.JSONType.String;}else if(E==='Edm.Boolean'){j=sap.ui.comp.smartfield.JSONType.Boolean;}else if(E==='Edm.Byte'||E==='Edm.SByte'||E==='Edm.Int16'||E==='Edm.Int32'){j=sap.ui.comp.smartfield.JSONType.Integer;}else{throw new Error("Unsupported parameter type: "+E);}var o=new c({value:B,mandatory:false,jsontype:j,maxLength:m});F.push(o);var l=new d();l.setText(P);l.setLabelFor(o);f.addContent(l);f.addContent(o);}var C=function(){var h=false;return h;};return{form:f,checkClientErrors:C};};A.prototype._getParameterName=function(p){return p["com.sap.vocabularies.Common.v1.Label"]?p["com.sap.vocabularies.Common.v1.Label"].String:p.name;};A.prototype._addParameterLabel=function(p,E){if(E&&p&&!p["com.sap.vocabularies.Common.v1.Label"]){var P=this._oMetaModel.getODataProperty(E,p.name,false);if(P&&P["com.sap.vocabularies.Common.v1.Label"]){p["com.sap.vocabularies.Common.v1.Label"]=P["com.sap.vocabularies.Common.v1.Label"];}}};return A;},true);
