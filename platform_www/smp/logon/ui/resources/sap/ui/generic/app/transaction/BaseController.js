/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/EventProvider","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/DraftUtil","sap/m/BusyDialog","sap/ui/generic/app/util/Queue"],function(q,E,M,D,B,Q){"use strict";var a=E.extend("sap.ui.generic.app.transaction.BaseController",{metadata:{publicMethods:["hasClientMessages","triggerSubmitChanges","attachFatalError","detachFatalError","destroy"]},constructor:function(m,o){if(!m){throw new Error("No model");}E.apply(this,arguments);this.sName="sap.ui.generic.app.transaction.BaseController";this._oModel=m;this._oMeta=m.getMetaModel();this._oDraftUtil=new D();this._oModelUtil=new M(m);if(o){this._oQueue=o;}else{this._oQueue=new Q(10);this._bOwnsQueue=true;}this._initCounts();}});a.prototype.attachFatalError=function(f,l){this.attachEvent("fatalError",f,l);};a.prototype.detachFatalError=function(f,l){this.detachEvent("fatalError",f,l);};a.prototype._prepareCallAction=function(f,c,p){var e,o,b,s,k;if(!f){throw new Error("Invalid Function Import");}p.urlParameters=p.urlParameters||{};p.functionImport=this._oMeta.getODataFunctionImport(f.split("/")[1]);if(!p.functionImport){throw new Error("Unknown Function Import "+f);}s=M.getEntitySetFromContext(c);e=this._oMeta.getODataEntitySet(s,false);o=this._oMeta.getODataEntityType(e.entityType,false);k=o.key.propertyRef;if(c){b=c.getObject();}if(b){this._getActionParameters(b,p,k);this._getAdditionalActionParameters(b,p,k);}return p;};a.prototype._callAction=function(f,c,p){var t=this;if(!p.urlParameters||!p.functionImport){p=this._prepareCallAction(f,c,p);}return new Promise(function(r,b){var F,C;F="/"+p.functionImport.name;C=t._getRequestCallBacks(r,b);t._oModel.callFunction(F,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,success:C.success,error:C.error,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers});});};a.prototype._getActionRequestHeaders=function(c,e,p){var s;if(!p.headers){p.headers={};}if(!p.headers["If-Match"]&&p.functionImport["sap:action-for"]){s=this._oModel.getETag(null,c,e);if(s){p.headers["If-Match"]=s;}}};a.prototype._getActionParameters=function(e,p,k){var i,b,l=k.length,A={},s;s=p.functionImport["sap:action-for"];b=function(P){if(p.functionImport.parameter){var j,c=p.functionImport.parameter.length;for(j=0;j<c;j++){if(p.functionImport.parameter[j].name===P){return true;}}}return false;};if(!p.functionImport.parameter&&s){q.sap.log.error("Action doesn't have any parameters");throw new Error("Action doesn't have any parameters");}for(i=0;i<l;i++){if(b(k[i].name)){p.urlParameters[k[i].name]=e[k[i].name];}else if(s){q.sap.log.error("Action parameters do not contain key property: "+k[i].name);throw new Error("Action parameters do not contain key property: "+k[i].name);}}return A;};a.prototype._getAdditionalActionParameters=function(e,p,k){var j,l=0,P,b=function(s){var i=0,c=k.length;for(i=0;i<c;i++){if(k[i].name===s){return true;}}return false;};if(p.functionImport.parameter){l=p.functionImport.parameter.length;}if(l>k.length){for(j=0;j<l;j++){P=p.functionImport.parameter[j];if(!b(P.name)){var n=(P.nullable==="true")?true:false;if(!p.urlParameters.hasOwnProperty(P.name)&&!n){q.sap.log.error("Unknown parameter "+P.name);throw new Error("Unknown parameter "+P.name);}}}}};a.prototype._read=function(p,P){var t=this;return new Promise(function(r,b){var c,u;if(P.urlParameters){u=P.urlParameters;}c=t._getRequestCallBacks(r,b);t._oModel.read(p,{success:c.success,error:c.error,batchGroupId:P.batchGroupId,changeSetId:P.changeSetId,urlParameters:u});});};a.prototype._remove=function(p,P){var t=this;return new Promise(function(r,b){var c=t._getRequestCallBacks(r,b);t._oModel.remove(p,{success:c.success,error:c.error,eTag:"*",batchGroupId:P.batchGroupId,changeSetId:P.changeSetId});});};a.prototype._submitChanges=function(p){var t=this,c;if(p&&p.context){c=p.context;}return new Promise(function(r,b){var P=false,C=t._getRequestCallBacks(r,b);P=t._oModel.hasPendingChanges();if(P||p.forceSubmit){p.pendingChanges=P;t._oModel.submitChanges({batchGroupId:p.batchGroupId,success:C.success,error:C.error,eTag:p.eTag});}else{r({context:c});}});};a.prototype.triggerSubmitChanges=function(p){var t=this,b,f;p=p||{};p.successMsg=p.successMsg||"Action succeeded";p.failedMsg=p.failedMsg||"Action failed";if(!p.noBlockUI){b=new B();b.open();}f=function(){return t._submitChanges(p).then(function(r){if(b){b.close();}t._checkImplicitError(r,p);return t._normalizeResponse(r,true);},function(r){var R=t._normalizeError(r);if(b){b.close();}t.fireEvent("fatalError",{response:R});throw R;});};return this._oQueue.enqueue(f);};a.prototype.hasClientMessages=function(){if(this._oModelUtil.hasClientMessages()){return Promise.reject(new Error("Client messages detected"));}return null;};a.prototype._normalizeResponse=function(r,c){if(r&&(r.httpResponse||r.responseData)){return{data:r.responseData,response:r.httpResponse||null,context:c?this._oModelUtil.getContextFromResponse(r.responseData):null};}return r;};a.prototype._normalizeError=function(r){if(r&&r.message){return{response:r};}return r;};a.prototype._returnPromiseAll=function(p){return Promise.all(p).then(function(r){if(r.length){return r[0];}return r;});};a.prototype._checkImplicitError=function(r,p){var P,o,s,c=false;if(this._mCounts.requestSent===1&&this._mCounts.requestCompleted===1){c=true;}this._initCounts();if(p.pendingChanges&&c){if(r&&r.responseData&&r.responseData.__batchResponses&&(r.responseData.__batchResponses.length===1)){P=r.responseData.__batchResponses[0];}if(P&&P.response&&P.response.statusCode){s=parseInt(P.response.statusCode,10);if(s<200||s>299){o=this._parseError(P);throw this._normalizeError(o);}}}};a.prototype._parseError=function(p){var r={};if(p.message){r.message=p.message;}if(p.response){r.statusCode=p.response.statusCode;r.statusText=p.response.statusText;r.headers=p.response.headers;r.responseText=p.response.body;}return r;};a.prototype._initCounts=function(){this._mCounts={requestSent:0,requestCompleted:0};};a.prototype._getRequestCallBacks=function(r,b){var t=this;this._mCounts.requestSent++;return{success:function(d,R){t._mCounts.requestCompleted++;r({responseData:d,httpResponse:R});},error:function(R){t._mCounts.requestCompleted++;b(R);}};};a.prototype.destroy=function(){if(this._oModelUtil){this._oModelUtil.destroy();}if(this._oQueue&&this._bOwnsQueue){this._oQueue.destroy();}this._oModel=null;this._oMeta=null;this._oDraftUtil=null;this._oModelUtil=null;};return a;},true);
