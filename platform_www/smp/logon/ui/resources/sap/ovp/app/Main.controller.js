(function(){"use strict";jQuery.sap.require("sap.ui.model.odata.ODataUtils");jQuery.sap.require("sap.ovp.cards.generic.Component");sap.ui.controller("sap.ovp.app.Main",{oCardsModels:{},oLoadedComponents:{},onInit:function(){},onBeforeRendering:function(){},onAfterRendering:function(){var v=this.getView();this._initGlobalFilter();var u=v.getModel("ui");var c=u.getProperty("/cards");var b=u.getProperty("/baseUrl");c.forEach(function(C,i){this.createLoadingCard(C);C.settings.baseUrl=b;this._initCardModel(C.model);this._loadCardComponent(C.template);},this);setTimeout(function(){c.forEach(function(C,i){this.createCard(C);},this);}.bind(this),1500);if(sap.ui.Device.system.phone){jQuery.sap.require("sap.ovp.ui.SmartphoneHeaderToggle");sap.ovp.ui.SmartphoneHeaderToggle.enable(this);}},verifyGlobalFilterLoaded:function(){if(this.globalFilter.search()){return true;}return false;},onGlobalFilterChange:function(){this.filterChanged=true;},onGlobalFilterSearch:function(){if(this.filterChanged){var b="ovp-"+new Date().getTime();for(var m in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(m)){this.oCardsModels[m].refresh(false,false,b);}}this.filterChanged=false;}},_initGlobalFilter:function(){this.globalFilter=this.getView().byId("ovpGlobalFilter");if(!this.globalFilter){return;}this.oGlobalFilterLodedPromise=new Promise(function(r,a){this.globalFilter.attachAfterVariantLoad(function(){if(this.verifyGlobalFilterLoaded()){r();}},this);this.globalFilter.attachInitialise(function(){if(!this.globalFilter.getCurrentVariantId()){if(this.verifyGlobalFilterLoaded()){r();}}},this);this.globalFilter.attachSearch(function(){r();this.onGlobalFilterSearch();},this);this.globalFilter.attachFilterChange(this.onGlobalFilterChange,this);}.bind(this));},_loadCardComponent:function(c){if(!this.oLoadedComponents[c]){this.oLoadedComponents[c]=sap.ui.component.load({name:c,url:jQuery.sap.getModulePath(c),async:true});}},_initCardModel:function(c){if(this.oCardsModels[c]){return;}this.oCardsModels[c]=this.getView().getModel(c);this.oCardsModels[c].setUseBatch(true);if(this.globalFilter){this._overrideCardModelRead(this.oCardsModels[c]);}},toggleFilterBar:function toggleFilterBar(){function t(j,b,h){b.height(h);j.css('top',0);}function a(j,b,h){b.height(0);j.css("top","-"+h+"px");}var i=this.globalFilter.getVisible();if((sap.ui.Device.system.phone)||(sap.ui.Device.system.tablet)){this.globalFilter.setVisible(!i);return;}if(toggleFilterBar.animationInProcess){return;}toggleFilterBar.animationInProcess=true;if(i){var j=jQuery(this.globalFilter.getDomRef());var b=jQuery(this.getView().byId("ovpGlobalFilterWrapper").getDomRef());var h=b.height();t(j,b,h);b.height();b.one('transitionend',function(e){this.globalFilter.setVisible(false);toggleFilterBar.animationInProcess=false;}.bind(this));a(j,b,h);}else{this.globalFilter.setVisible(true);setTimeout(function(){var j=jQuery(this.globalFilter.getDomRef());var b=jQuery(this.getView().byId("ovpGlobalFilterWrapper").getDomRef());var h=j.outerHeight();a(j,b,h);b.height();b.one('transitionend',function(e){b.css("height","auto");toggleFilterBar.animationInProcess=false;});t(j,b,h);}.bind(this));}},_overrideCardModelRead:function(m){var o=m.read;var t=this;m.read=function(){var f=t.globalFilter.getFilters();var p=arguments[1];if(!p){p={};Array.prototype.push.call(arguments,p);}var e=t._getEntityTypeFromPath(m,arguments[0],p.context);if(e){var r=t._getEntityRelevantFilters(e,f);if(r.length>0){var a=-1;var u=p.urlParameters;if(u){for(var i=0;i<u.length;i++){if((u[i]).lastIndexOf("$filter=",0)===0){a=i;break;}}}if(a>=0){u[a]=u[a]+"%20and%20"+sap.ui.model.odata.ODataUtils.createFilterParams(f,m.oMetadata,e).substr(8);}else{p.filters=r;}}}o.apply(m,arguments);};},_getEntityTypeFromPath:function(m,p,c){var n=sap.ui.model.odata.v2.ODataModel.prototype._normalizePath.apply(m,[p,c]);var e=sap.ui.model.odata.ODataMetadata.prototype._getEntityTypeByPath.apply(m.oMetadata,[n]);return e;},_getEntityRelevantFilters:function(e,f){var r=[];if(f.length){var a=f[0].aFilters;var b=e.property;for(var i=0;i<a.length;i++){var c;if(a[i].aFilters){c=a[i].aFilters[0].sPath;}else{c=a[i].sPath;}for(var j=0;j<b.length;j++){if(b[j].name===c){r.push(a[i]);break;}}}}return r;},_checkIsCardValid:function(c){var C=c+".Component";var o,a;jQuery.sap.require(C);var b=jQuery.sap.getObject(C);if(!b){return false;}if((b!==sap.ovp.cards.generic.Component)&&!(b.prototype instanceof sap.ovp.cards.generic.Component)){return false;}if((o=b.getMetadata())&&(a=o.getCustomizing())){if(a["sap.ui.viewReplacements"]&&a["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false;}}if(b.prototype.createContent!=sap.ovp.cards.generic.Component.prototype.createContent){return false;}if(b.prototype.getPreprocessors!=sap.ovp.cards.generic.Component.prototype.getPreprocessors){return false;}return true;},_createCardComponent:function(v,m,c){if(c.template&&this._checkIsCardValid(c.template)){var C={name:c.template,componentData:{model:m,settings:c.settings}};if(this.globalFilter){C.componentData.globalFilter={getFilterDataAsString:this.globalFilter.getDataSuiteFormat.bind(this.globalFilter)};}var o=sap.ui.component(C);var a=v.byId(c.id);var O=a.getComponentInstance();a.setComponent(o);if(O){setTimeout(function(){O.destroy();},0);}}else{jQuery.sap.log.error("Could not create Card from '"+c.template+"' template. Card is not valid.");}},createLoadingCard:function(c,o){var l=jQuery.extend(true,{},c,{template:"sap.ovp.cards.loading",settings:{opacityDelay:o}});this._createCardComponent(this.getView(),undefined,l);},createCard:function(c){var v=this.getView();var m=v.getModel(c.model);Promise.all([m.getMetaModel().loaded(),this.oGlobalFilterLodedPromise,this.oLoadedComponents[c.template]]).then(function(){this._createCardComponent(v,m,c);}.bind(this),function(r){jQuery.sap.log.error("Can't load card with id:'"+c.id+"' and type:'"+c.template+"', reason:"+r);});}});}());
