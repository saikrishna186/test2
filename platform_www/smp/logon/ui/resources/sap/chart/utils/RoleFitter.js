/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/ui5/data/DimensionDefinition','sap/viz/ui5/data/MeasureDefinition','sap/viz/ui5/controls/common/feeds/FeedItem','sap/viz/ui5/controls/common/feeds/AnalysisObject'],function(D,M,F,A){var s=sap.viz.vizservices.BVRService.suggestFeeds;var c=function(a,f){return sap.viz.vizservices.FeedService.validate(a,s(a,f,[{id:"MND",type:"MND"}]).feedItems);};var _=[{"types":"*","toViz":{"category|category2":"categoryAxis","series":"color","axis1":"valueAxis"}},{"types":"column|bar|stacked_bar|stacked_column|line|combination|100_stacked_bar|100_stacked_column|stacked_combination|horizontal_stacked_combination","toViz":{"axis2|axis3":"valueAxis"}},{"types":"scatter|bubble|time_bubble|timeseries_scatter|timeseries_bubble","toViz":{"series":"series","category|category2":"series","axis1":"valueAxis","axis2":"valueAxis2"}},{"types":"bubble|time_bubble","toViz":{"axis3":"bubbleWidth"}},{"types":"pie|donut","toViz":{"category|series|category2":"color","axis1|axis2|axis3":"size"}},{"types":"bullet|vertical_bullet","toViz":{"axis1":"actualValues","axis2":"targetValues","axis3":"forecastValues","axis4":"additionalValues"}},{"types":"dual_combination|dual_stacked_bar|100_dual_stacked_bar|dual_stacked_column|100_dual_stacked_column|dual_bar|dual_column|dual_line|dual_stacked_combination|dual_horizontal_stacked_combination","toViz":{"axis1":"valueAxis","axis2":"valueAxis2","axis3":"valueAxis2"}},{"types":"timeseries_line","toViz":{"category":"timeAxis","axis1|axis2|axis3":"valueAxis"}},{"types":"timeseries_scatter","toViz":{"category":"timeAxis","axis2|axis3":false}},{"types":"timeseries_bubble","toViz":{"category":"timeAxis","axis2":false,"axis3":"bubbleWidth"}},{"types":"heatmap","toViz":{"category":"categoryAxis","category2":"categoryAxis2","axis1|axis2|axis3":"color"}}].reduce(function(m,a){var b=Object.keys(a.toViz).reduce(function(b,f){f.split("|").forEach(function(r){b[r]=a.toViz[f];return b;});return b;},{});a.types.split("|").forEach(function(f){if(!m.hasOwnProperty(f)){m[f]=[];}m[f].push(b);});return m;},{});var d=Object.keys(_).reduce(function(m,a){if(a!=="*"){m[a]=jQuery.extend.apply(null,[true,{}].concat(_["*"].concat(_[a])));}return m;},{});function e(L,k){var a=(typeof k==="function")?k:function(o){return o[k];};return L.reduce(function(G,E){var b=a(E);if(!G[b]){G[b]=[E];}else{G[b].push(E);}return G;},{});}function g(L,k){return L.reduce(function(m,a,b){m[k(a)]=b;return m;},{});}function h(m,a){var G=e(a,function(o){return o.getRole();});return Object.keys(G).reduce(function(r,R){if(m[R]){var f=m[R];if(!r.hasOwnProperty(f)){r[f]=[];}r[f]=r[f].concat(G[R]);delete G[R];}return r;},{});}var i={"Edm.DateTime":true};var j={timeseries_line:true,timeseries_bubble:true,timeseries_scatter:true};var l={line:"timeseries_line"};function p(C,a){if(C.length!==1){return false;}var m=a.filter(function(o){return o.getName()===C[0];})[0];if(!m){return false;}return i[m.getKeyProperty().type];}function q(T,m){return function(I){return new F({uid:I,type:T,values:m[I].map(function(o){return o.getName();})});};}function t(T,m){return function(o){var a={id:o.getName(),name:o.getName(),type:T};if(T==="Dimension"&&i[m[a.id]]){a.dataType="Date";}return a;};}function w(o){var n=o.getName(),L=o.getLabel(),T=o.getTextProperty(),f=o.getTextFormatter(),b=o.getDisplayText();var a={identity:n,name:L||n,value:"{"+n+"}"};if(typeof f==="function"){a.displayValue={formatter:f,parts:[{path:n,type:new sap.ui.model.type.String()}]};if(T){a.displayValue.parts.push({path:T,type:new sap.ui.model.type.String()});}}else if(b&&T){a.displayValue="{"+T+"}";}return new D(a);}function u(m){var n=m.getName(),U=m.getUnitBinding(),v=m.getValueFormat();var a={identity:n,name:m.getLabel()||n,value:"{"+n+"}"};var b=[];if(U){b.push(U);b.push(v?v:"#");}else if(v){b.push(v);}if(b.length>0){a.format=b.join(" ");}return new M(a);}function x(C,a,m,S,b){var r=d[C];var k=h(r,a),o=h(r,m);if(k.series){k[S]=k.series;delete k.series;}var E=Object.keys(k).filter(function(I){return k[I]&&k[I].length>0;}).map(q("Dimension",k)).concat(Object.keys(o).filter(function(I){return o[I]&&o[I].length>0;}).map(q("Measure",o)));var L=F.toLightWeightFmt(E),V=c("info/"+C,L);var G=V.valid?E:y(C,V,L,a,m,b),H=G.reduce(function(n,f){f.getValues().forEach(function(v){n[(v instanceof A)?v.getUid():v]=true;});return n;},{});G._unused=a.concat(m).filter(function(n){return!H[n.getName()];}).map(function(n){return n.getName();});G._def=z(a,m,H);if(j[C]){B(G);}return G;}function y(C,V,E,f,m,n){var r=sap.viz.api.metadata.Viz.get("info/"+C),G=e(r.bindings,"id"),H=false,I=false;Object.keys(V.results.bindings).forEach(function(k){if(!G[k]){return;}if(G[k][0].type==="Measure"){I=true;}if(G[k][0].type==="Dimension"){H=true;}});var J=E.filter(function(a){return!((a.type==="Dimension")?H:I);}),K=J.reduce(function(a,b){(b.values||[]).forEach(function(v){a[v.id]=true;});return a;},{});var L=f.map(t("Dimension",n)),N=m.map(t("Measure")),O=g(f,function(o){return o.getName();}),P=g(m,function(o){return o.getName();});L.sort(function(a,b){return O[a.id]-O[b.id];});N.sort(function(a,b){return P[a.id]-P[b.id];});var S=s("info/"+C,J,L.concat(N).filter(function(a){return!K[a.id];})).feedItems;S.forEach(function(o){o.type=G[o.id][0].type;});return F.fromLightWeightFmt(S);}function z(a,m,v){return{dim:a.reduce(function(V,o){if(v[o.getName()]){V.push(w(o));}return V;},[]),msr:m.reduce(function(V,o){if(v[o.getName()]){V.push(u(o));}return V;},[])};}function B(f){var T=f.filter(function(o){return o.getUid()==="timeAxis";})[0],a=T.getValues().map(function(o){return(typeof o==="string")?o:o.getUid();});f._def.dim.forEach(function(o){if(a.indexOf(o.getIdentity())!==-1){o.setDataType("Date");}});}return{fit:x};});
